<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ˆæ¥­è¡¨å–®è¦æ ¼ç”Ÿæˆå™¨ v62.31 (Final Fixes & Temp UI)</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        /* --- æ ¸å¿ƒè®Šæ•¸ --- */
        :root { 
            --p: #1a73e8; 
            --bg: #f8f9fa; 
            --border: #dadce0; 
            --radius: 4px; 
            --danger: #d93025; 
            --highlight: #fef08a; 
            --temp-btn-bg: #fbc02d;
            --temp-btn-text: #202124;
            --submit-btn-bg: #34a853;
            --submit-btn-text: #ffffff;
        }

        * { box-sizing: border-box; }

        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            margin: 0; 
            padding: 5px; 
            display: flex; 
            height: 100vh; 
            overflow: hidden; 
            background: var(--bg); 
            color: #202124; 
            gap: 8px; 
        }
        
        /* --- ä½ˆå±€ (Layout) --- */
        .sidebar-l { 
            width: 240px; 
            background: #fff; 
            border: 1px solid var(--border); 
            display: flex; 
            flex-direction: column; 
            flex-shrink: 0; 
            border-radius: 4px; 
            transition: 0.3s; 
        }

        .sidebar-r { 
            width: 360px; 
            background: #fff; 
            border: 1px solid var(--border); 
            padding: 10px; 
            overflow-y: auto; 
            flex-shrink: 0; 
            border-radius: 4px; 
            transition: 0.3s; 
        }

        .scroll-area { 
            flex: 1; 
            overflow-y: auto; 
            padding: 10px; 
        }

        .canvas-area { 
            flex: 1; 
            padding: 10px 20px; 
            overflow-y: auto; 
            background: #eef1f4; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            border: 1px solid var(--border); 
            border-radius: 4px; 
            position: relative; 
        }

        .canvas-container { 
            width: 100%; 
            max-width: 900px; 
            padding-bottom: 100px; 
        }

        /* --- é è¦½æ¨¡å¼ (Preview Mode) --- */
        .preview-bar { 
            display: none; 
            width: 100%; 
            background: #333; 
            color: #fff; 
            padding: 10px; 
            text-align: center; 
            position: absolute; 
            top: 0; 
            left: 0; 
            z-index: 9999; 
            justify-content: center; 
            gap: 20px; 
            align-items: center; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        body.preview-mode .preview-bar { display: flex; }
        
        body.preview-mode .sidebar-l, 
        body.preview-mode .sidebar-r { 
            display: none !important; 
        }

        body.preview-mode .canvas-area { 
            max-width: 100%; 
            padding: 40px 20px; 
        }

        body.preview-mode .card { 
            border: 1px solid transparent; 
            box-shadow: none; 
            background: #fff; 
            margin-bottom: 15px; 
            padding: 15px; 
            border-bottom: 1px solid #eee; 
        }
        body.preview-mode .card.selected { 
            border: 1px solid transparent !important; 
            box-shadow: none !important; 
        }
        
        /* é è¦½æ¨¡å¼ï¼šé–å®šç·¨è¼¯å…ƒç´  */
        body.preview-mode .no-drag { pointer-events: auto !important; cursor: text; }
        body.preview-mode .fake-icon { cursor: pointer !important; pointer-events: auto !important; }
        body.preview-mode select, body.preview-mode input, body.preview-mode textarea { pointer-events: auto !important; }
        
        /* é è¦½æ¨¡å¼ï¼šç¦æ­¢ä¿®æ”¹æ¨™é¡Œèªªæ˜ */
        body.preview-mode .title-inp, 
        body.preview-mode .desc-inp { 
            pointer-events: none !important; 
            border-bottom: none !important; 
            background: transparent !important; 
            color: #000; 
        }
        
        /* é è¦½æ¨¡å¼ï¼šéš±è—å·¥å…· */
        body.preview-mode .card-tools, 
        body.preview-mode .grid-add-btn, 
        body.preview-mode .del-col-btn, 
        body.preview-mode .del-row-btn,
        body.preview-mode .opt-manage-item span { 
            display: none !important; 
        }

        /* --- Typography & Buttons --- */
        h3 { border-bottom: 2px solid #333; margin: 0 0 8px 0; padding-bottom: 5px; font-size: 0.95rem; font-weight: bold; }
        .cat { font-size: 11px; font-weight: bold; color: #70757a; margin: 10px 0 4px 0; text-transform: uppercase; border-left: 3px solid var(--p); padding-left: 5px; }
        .btn-t { width: 100%; padding: 8px; margin-bottom: 4px; background: #fff; border: 1px solid var(--border); border-radius: 4px; cursor: pointer; text-align: left; font-size: 13px; display: flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-t:hover { background: #f8f9fa; border-color: var(--p); color: var(--p); }
        .btn-main { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 13px; transition: 0.2s; }
        .btn-main:active { transform: scale(0.98); }
        .btn-blue { background: var(--p); color: #fff; }

        /* --- Cards --- */
        .meta-card { background: #fff; border: 1px solid var(--border); border-radius: var(--radius); padding: 15px; border-top: 8px solid #333; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; transition: 0.2s; }
        .meta-card.selected { border: 2px solid var(--p); box-shadow: 0 0 8px rgba(26, 115, 232, 0.2); }
        .sortable-list { display: grid; grid-template-columns: repeat(12, 1fr); gap: 10px; min-height: 100px; width: 100%; }
        .card { grid-column: span 12; background: #fff; border: 1px solid var(--border); border-radius: var(--radius); padding: 15px; position: relative; cursor: default; transition: 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .card.selected { border: 2px solid var(--p) !important; box-shadow: 0 0 8px rgba(26, 115, 232, 0.3); z-index: 10; }
        .card.error-state { border: 2px solid var(--danger) !important; background: #fff5f5; }
        .w-100 { grid-column: span 12; } .w-50 { grid-column: span 6; } .w-33 { grid-column: span 4; }
        
        /* --- Inputs --- */
        .title-inp { width: 100%; border: none; border-bottom: 1px solid transparent; outline: none; background: transparent; transition: 0.2s; padding: 2px; font-weight: bold; min-width: 0; resize: none; overflow: hidden; font-family: inherit; display: block; height: auto; position: relative; z-index: 2; }
        .title-inp:hover { border-bottom: 1px dashed #ccc; }
        .title-inp:focus { border-bottom: 2px solid var(--p); background: #fefefe; }
        .desc-inp { width: 100%; border: none; border-bottom: 1px solid #eee; padding: 4px 2px; font-size: 13px; outline: none; background: transparent; resize: none; overflow: hidden; font-family: inherit; color: #666; position: relative; z-index: 2; }
        .desc-inp:focus { border-bottom: 1px solid var(--p); color: #333; background: #fff; }
        
        .style-v27-box { width: 100%; border: 1px solid #ccc; border-radius: 4px; padding: 4px 6px; font-size: 12px; height: 28px; outline: none; transition: 0.2s; background: #fff; position: relative; z-index: 2; }
        .style-v27-box:focus { border-color: var(--p); box-shadow: 0 0 0 2px rgba(26,115,232,0.1); }
        .style-v27-box.error-field, .error-field { border-color: var(--danger) !important; background-color: #fff0f0 !important; box-shadow: 0 0 0 1px var(--danger) !important; }
        
        /* --- Batch & Custom Row --- */
        .batch-container { display: flex; align-items: center; gap: 8px; padding: 8px 12px; border: 1px solid #e0e0e0; border-radius: 6px; background: #fff; width: 100%; margin-top: 5px; flex-wrap: wrap; }
        .batch-label { display: flex; align-items: center; gap: 4px; font-weight: bold; font-size: 13px; margin-right: 8px; white-space: nowrap; cursor: pointer; }
        .batch-input-flex { flex: 1; min-width: 0; text-align: center; width: 100%; border: 1px solid #ccc; border-radius: 4px; padding: 4px; outline: none; position: relative; z-index: 2; }
        .remark-box { width: 100%; border: 1px solid #ccc; border-radius: 6px; padding: 8px; font-size: 13px; resize: vertical; outline: none; transition: 0.2s; background: #fff; min-height: 60px; position: relative; z-index: 2; }
        .remark-box:focus { border-color: var(--p); box-shadow: 0 0 0 2px rgba(26,115,232,0.1); }
        
        /* --- Grid System --- */
        .grid-table { width: 100%; border-collapse: collapse; margin-top: 5px; table-layout: fixed; }
        .grid-table th, .grid-table td { border: 1px solid #ddd; padding: 4px; text-align: center; vertical-align: middle; position: relative; font-size: 13px; }
        .grid-inp { border: none; text-align: center; width: 100%; outline: none; font-weight: bold; background: transparent; font-size: 12px; position: relative; z-index: 2; }
        .grid-inp:focus { border-bottom: 2px solid var(--p); }
        .grid-cell-wrapper { display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; gap: 6px; }
        .slash-header { position: relative; background-color: #fff; height: 45px; background-image: linear-gradient(to bottom right, transparent calc(50% - 0.5px), #ddd calc(50% - 0.5px), #ddd calc(50% + 0.5px), transparent calc(50% + 0.5px)); }
        .slash-top { position: absolute; top: 2px; right: 4px; width: 45%; border: none; background: transparent; text-align: right; font-size: 11px; outline: none; color: #666; font-weight: bold; z-index: 2; }
        .slash-bot { position: absolute; bottom: 2px; left: 4px; width: 45%; border: none; background: transparent; text-align: left; font-size: 11px; outline: none; color: #666; font-weight: bold; z-index: 2; }
        .del-col-btn { position: absolute; top: -10px; right: -5px; color: var(--danger); cursor: pointer; font-size: 14px; background: #fff; border-radius: 50%; padding: 0 4px; display: none; border: 1px solid #eee; z-index: 5; }
        .grid-table th:hover .del-col-btn { display: block; }
        .del-row-btn { font-size: 16px; color: #bbb; cursor: pointer; margin-left: 6px; vertical-align: middle; visibility: hidden; padding: 2px; }
        .grid-table tr:hover .del-row-btn { visibility: visible; }
        .del-row-btn:hover { color: var(--danger); }
        .grid-add-btn { display: flex; align-items: center; justify-content: center; background: #fdfdfd; color: #f9c22e; font-weight: bold; cursor: pointer; transition: 0.2s; text-shadow: 0 0 1px #999; font-size: 20px; position: relative; z-index: 2; }
        .grid-add-btn:hover { background: #eee; }
        .grid-header-mode-icon { position:absolute; top:2px; left:2px; font-size:12px; cursor:pointer; opacity:0.6; z-index:10; background:rgba(255,255,255,0.8); border-radius:3px; padding:1px; }
        .grid-header-mode-icon:hover { opacity:1; background:#fff; box-shadow: 0 0 2px rgba(0,0,0,0.2); }

        /* --- Icons --- */
        .fake-icon { display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; border: 2px solid #ccc; background: #fff; cursor: pointer; flex-shrink: 0; font-size: 14px; color: transparent; font-weight: bold; transition: 0.2s; user-select: none; position: relative; z-index: 2; }
        .fake-icon:hover { border-color: #999; }
        .fake-icon.radio { border-radius: 50%; }
        .fake-icon.checkbox { border-radius: 4px; }
        .fake-icon.checked-v { border-color: var(--p); background-color: #f0f7ff; color: var(--p); } .fake-icon.checked-v::after { content: 'âœ“'; }
        .fake-icon.checked-x { border-color: var(--danger); background-color: #fff5f5; color: var(--danger); font-size: 12px; } .fake-icon.checked-x::after { content: 'âœ•'; }
        .fake-icon.radio.checked-x::after { content: 'âœ•'; }
        
        /* --- Options & Layout --- */
        .opt-container { width: 100%; display: flex; gap: 8px; }
        .opt-container.vertical { flex-direction: column; }
        .opt-container.horizontal { flex-direction: row; flex-wrap: wrap; }
        .opt-container.horizontal .opt-item { min-width: 120px; }
        .opt-item { display: flex; align-items: center; gap: 8px; margin-top: 5px; cursor: pointer; }
        .opt-item span { white-space: nowrap; flex-shrink: 0; }
        .opt-item .style-v27-box { flex: 1; min-width: 0; width: auto; margin-left: 0; }
        .preview-dropdown { display: flex; justify-content: space-between; align-items: center; border: 1px solid #ccc; padding: 10px; border-radius: 8px; background: #fff; color: #666; font-size: 14px; cursor: pointer; }
        
        /* --- Sidebar & Logic Elements --- */
        .p-item { margin-bottom: 15px; }
        .p-item label { display: flex; align-items: center; font-weight: bold; font-size: 13px; margin-bottom: 5px; }
        .inp-p { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; }
        .p-row-flex { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; }
        .p-check-row { display: flex; align-items: center; gap: 8px; font-size: 13px; margin-bottom: 6px; font-weight: 500; cursor: pointer; }
        .biu-btn { border: 1px solid #ccc; background: #fff; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px; }
        .biu-btn.active { background: #333; color: #fff; border-color: #333; }
        .sec-divider { margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px; }
        .add-link { color: var(--p); font-size: 12px; font-weight: bold; cursor: pointer; margin-top: 8px; display: inline-block; }
        .logic-panel { background: #fffde7; border: 1px dashed #fbc02d; padding: 10px; border-radius: 8px; margin-top: 8px; }
        .logic-line { display: flex; align-items: center; gap: 6px; margin-bottom: 6px; font-size: 12px; flex-wrap: nowrap; width: 100%; white-space: nowrap; overflow: hidden; }
        .logic-line input, .logic-line select { padding: 4px; border: 1px solid #ccc; border-radius: 3px; font-size: 12px; flex-shrink: 0; }
        .time-inp-fix { width: 105px; flex-shrink: 0; } 
        .logic-val-input { flex: 1; min-width: 0; }
        .logic-del-btn { cursor: pointer; margin-left: auto; font-weight: bold; color: #999; flex-shrink: 0; padding: 0 4px; }
        .opt-manage-item { display: flex; align-items: center; gap: 5px; margin-bottom: 6px; cursor: move; background: #fff; padding: 4px; border: 1px solid #eee; border-radius: 4px; }
        .opt-manage-item input { flex: 1; padding: 6px; border: 1px solid #eee; border-radius: 4px; font-size: 12px; }
        .opt-manage-item span { cursor: pointer; color: #ccc; }
        .opt-manage-item span:hover { color: var(--danger); }
        .opt-drag-handle { color: #ccc; cursor: move; margin-right: 4px; font-size: 14px; }
        
        /* --- Footer & Temp List --- */
        .footer-actions { margin-top: 20px; width: 100%; display: flex; flex-direction: column; gap: 10px; }
        .action-row { display: flex; gap: 10px; width: 100%; }
        .btn-temp { flex: 1; background: var(--temp-btn-bg); color: var(--temp-btn-text); border: none; padding: 12px; border-radius: 6px; font-weight: bold; cursor: pointer; text-align: center; transition: 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .btn-temp:hover { opacity: 0.9; }
        .btn-submit { flex: 2; background: var(--submit-btn-bg); color: var(--submit-btn-text); border: none; padding: 12px; border-radius: 6px; font-weight: bold; cursor: pointer; text-align: center; transition: 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .btn-submit:hover { opacity: 0.9; }
        
        /* Temp List Table Style */
        .temp-table-view { background: #fff; border: 1px solid #ddd; border-radius: 6px; padding: 15px; font-size: 12px; margin-top: 10px; }
        .temp-table-header { font-weight: bold; margin-bottom: 8px; color: #333; font-size: 14px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .temp-record-list { width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 12px; }
        .temp-record-list th { background: #f8f9fa; padding: 8px; text-align: left; border-bottom: 2px solid #ddd; font-weight: bold; color: #555; }
        .temp-record-list td { padding: 8px; border-bottom: 1px solid #eee; vertical-align: middle; color: #333; }
        .temp-record-list tr:last-child td { border-bottom: none; }
        .temp-actions span { color: var(--p); cursor: pointer; margin-right: 8px; font-weight: bold; }
        .temp-actions span.del { color: var(--danger); }

        /* --- Modals & Palette --- */
        .palette-btn { display: flex; align-items: center; gap: 2px; padding: 2px 4px; border: 1px solid transparent; border-radius: 3px; cursor: pointer; background: transparent; transition: 0.1s; position: relative; height: 32px; }
        .palette-btn:hover { background: #e0e0e0; border-color: #ccc; }
        .palette-popover { display: none; position: absolute; top: 35px; left: 0; background: #fff; border: 1px solid #bababa; box-shadow: 0 4px 8px rgba(0,0,0,0.2); padding: 6px; border-radius: 2px; z-index: 3000; width: 190px; }
        .palette-popover.active { display: block; }
        .color-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; margin-bottom: 4px; }
        .color-cell { width: 28px; height: 28px; border: 1px solid #ddd; cursor: pointer; position: relative; }
        .color-cell:hover { outline: 1px solid #ff9800; z-index: 10; transform: scale(1.1); }
        .color-cell.transparent { background: linear-gradient(to bottom right, #fff 45%, #f00 50%, #fff 55%); border: 1px solid #ccc; }
        
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: #fff; width: 90%; max-width: 600px; height: 80vh; border-radius: 8px; display: flex; flex-direction: column; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .modal-header { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 16px; }
        .modal-body { flex: 1; overflow-y: auto; padding: 15px; }
        .modal-footer { padding: 15px; border-top: 1px solid #eee; text-align: right; background: #f9f9f9; border-radius: 0 0 8px 8px; }
        .temp-section-title { font-size: 14px; font-weight: bold; margin-bottom: 8px; color: #333; background: #e8f0fe; padding: 5px 8px; border-radius: 4px; }
        .calc-box { background: #fdfdfd; border: 1px solid #e0e0e0; padding: 10px; border-radius: 6px; margin-bottom: 10px; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .calc-box .del-calc { position: absolute; top: 8px; right: 8px; color: #ccc; cursor: pointer; font-size: 16px; }
        .calc-box .del-calc:hover { color: var(--danger); }
        .time-row { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; }
        
        /* --- Validation Rule Item (New Style) --- */
        .val-rule-item { display: flex; align-items: center; gap: 4px; margin-bottom: 6px; background: #fdfdfd; padding: 4px; border-radius: 4px; border: 1px solid #eee; flex-wrap: nowrap; width: 100%; white-space: nowrap; overflow: hidden; }
        .val-rule-item select, .val-rule-item input { padding: 4px; border: 1px solid #ccc; border-radius: 3px; font-size: 12px; height: 26px; box-sizing: border-box; }
        .val-type-sel { width: 55px; min-width: 55px; flex-shrink: 0; text-align:center; }
        .val-op-sel { width: 35px; min-width: 35px; flex-shrink: 0; text-align: center; }
        .val-inp { flex: 1; min-width: 40px; }
        .val-del { flex-shrink: 0; cursor: pointer; color: #999; margin-left: auto; padding: 0 4px; font-weight: bold; }
        
        /* --- Helpers --- */
        .info-icon { display: inline-flex; align-items: center; justify-content: center; width: 14px; height: 14px; background: #ccc; color: #fff; border-radius: 50%; font-size: 10px; margin-left: 6px; cursor: help; font-weight: bold; }
        .global-tooltip { position: fixed; background: #222; color: #fff; padding: 10px; border-radius: 6px; z-index: 10000; font-weight: normal; font-family: sans-serif; line-height: 1.4; font-size: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); pointer-events: none; max-width: 250px; text-align: left; }
        .ui-hint-badge { display: inline-block; font-size: 10px; padding: 1px 4px; border-radius: 3px; margin-left: 5px; background-color: #f1f3f4; color: #5f6368; border: 1px solid #dadce0; vertical-align: middle; }
        .card-tools { display: flex; justify-content: flex-end; gap: 15px; margin-top: 15px; padding-top: 10px; border-top: 1px solid #f0f0f0; }
        .tool-action { font-size: 12px; color: #666; cursor: pointer; display: flex; align-items: center; gap: 4px; font-weight: 600; }
        .tool-action:hover { color: var(--p); }
        .err-msg { font-size: 11px; color: var(--danger); font-weight: bold; margin-top: 4px; display: none; }
        .err-msg.show { display: block; }
        
        /* Unit Dropdown */
        .unit-label-container { display: flex; align-items: center; background: #f0f0f0; border-left: 1px solid #ccc; position: relative; }
        .unit-text-display { padding: 0 8px; font-size: 12px; color: #555; white-space: nowrap; }
        .unit-dropdown-menu { position: absolute; top: 100%; right: 0; min-width: 80px; background: #fff; border: 1px solid #ccc; box-shadow: 0 3px 8px rgba(0,0,0,0.15); z-index: 100; display: none; flex-direction: column; border-radius: 4px; overflow: hidden; }
        .unit-dropdown-menu.active { display: flex; }
        .unit-option { padding: 6px 10px; font-size: 12px; cursor: pointer; color: #333; transition: 0.1s; }
        .unit-option:hover { background: #444; color: #fff; }
        
        /* Multi-Select Dropdown */
        .ms-container { position: relative; width: 100%; }
        .ms-trigger { padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; background: #fff; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-size: 13px; color: #333; }
        .ms-dropdown { display: none; position: absolute; top: 100%; left: 0; width: 100%; background: #fff; border: 1px solid #ccc; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 50000; margin-top: 4px; overflow: hidden; max-height: 250px; flex-direction: column; }
        .ms-dropdown.active { display: flex; }
        .ms-list { flex: 1; overflow-y: auto; padding: 5px 0; }
        .ms-item { display: flex; align-items: center; padding: 6px 10px; cursor: pointer; font-size: 13px; transition: 0.1s; }
        .ms-item:hover { background: #f0f7ff; }
        .ms-footer { display: flex; border-top: 1px solid #eee; }
        .ms-btn { flex: 1; padding: 8px; text-align: center; cursor: pointer; font-size: 13px; border: none; background: #fff; transition: 0.2s; }
        .ms-btn:hover { background: #f5f5f5; }
        
        .selected-tags-container { display:flex; flex-wrap:wrap; gap:4px; margin-top:5px; padding:4px; border:1px solid #eee; border-radius:4px; background:#f9f9f9; min-height:28px; }
        .sel-tag { font-size:11px; background:#e8f0fe; color:#1a73e8; padding:2px 6px; border-radius:10px; display:inline-flex; align-items:center; }
        .clear-tags-btn { font-size:11px; color:#d93025; cursor:pointer; text-decoration:underline; margin-left:auto; margin-top:2px; display:block; text-align:right; }
    </style>
</head>
<body>

    <div class="preview-bar">
        <span>ğŸ‘ï¸ ç›®å‰ç‚ºé è¦½æ¨¡å¼ï¼šè«‹æ¸¬è©¦å¡«å¯«èˆ‡é©—è­‰ (ç·¨è¼¯åŠŸèƒ½å·²éš±è—)</span>
        <button class="btn-main" style="width:auto; padding:6px 15px; background:#444; color:#fff;" onclick="togglePreviewMode()">âŒ é€€å‡ºé è¦½</button>
    </div>

    <div id="tempConfigModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <span>âš™ï¸ è¨­å®šæš«å­˜èˆ‡çµ±è¨ˆè¦å‰‡</span>
                <span style="cursor:pointer;" onclick="closeTempModal()">âœ•</span>
            </div>
            <div class="modal-body">
                <div class="temp-section-title">1. åŸºæœ¬æ¬„ä½é¡¯ç¤º</div>
                <div id="msBasicFields" class="ms-container"></div>

                <div class="temp-section-title" style="margin-top:20px;">2. é€²éšçµ±è¨ˆèˆ‡åˆä½µ</div>
                <div id="modalCalcList"></div>
                <button class="btn-main" style="background:#fff; border:1px dashed #999; margin-top:8px;" onclick="addTempCalc()">+ æ–°å¢çµ±è¨ˆæ¬„</button>

                <div class="temp-section-title" style="margin-top:20px;">3. è‡ªå‹•æ¸…ç©ºè¨­å®š</div>
                <label class="p-check-row"><input type="checkbox" id="mClearOnSubmit"> ç•¶æ‰€æœ‰ç´€éŒ„é€å‡ºå¾Œè‡ªå‹•æ¸…ç©º</label>
                <div style="font-size:13px; font-weight:bold; margin:8px 0 4px 0;">æŒ‡å®šæ¸…ç©ºæ™‚é–“é»ï¼š</div>
                <div id="modalTimeList"></div>
                <span class="add-link" onclick="addClearTime()">+ æ–°å¢æ™‚é–“é»</span>
            </div>
            <div class="modal-footer">
                <button class="btn-main btn-blue" style="width:auto; padding:8px 20px;" onclick="saveTempModal()">ç¢ºèªå„²å­˜</button>
            </div>
        </div>
    </div>

    <div class="sidebar-l">
        <div class="scroll-area">
            <button class="btn-main" style="background:#333; color:#fff; margin-bottom:10px;" onclick="togglePreviewMode()">ğŸ‘ï¸ é–‹å•Ÿé è¦½æ¨¡å¼</button>
            <h3>æ¬„ä½é¡å‹</h3>
            <div class="cat">è¼¸å…¥èˆ‡å·¥æ¥­</div>
            <button class="btn-t" onclick="hAdd('text')">ğŸ“ æ–‡å­—æ¡†</button>
            <button class="btn-t" onclick="hAdd('batch')">ğŸ”¢ æ‰¹è™Ÿ</button>
            <button class="btn-t" onclick="hAdd('custom_row')">ğŸ§© è‡ªè¨‚çµ„åˆ</button>
            <button class="btn-t" onclick="hAdd('machine')">ğŸ¤– æ©Ÿå°</button>
            <button class="btn-t" onclick="hAdd('remark')">ğŸ—¨ï¸ å‚™è¨»</button>
            <div class="cat">é¸æ“‡èˆ‡æ ¼é»</div>
            <button class="btn-t" onclick="hAdd('choices')">ğŸ”˜ å–®é¸ / å¤šé¸</button>
            <button class="btn-t" onclick="hAdd('dropdown')">ğŸ”½ ä¸‹æ‹‰é¸å–®</button>
            <button class="btn-t" onclick="hAdd('grid')">â–¦ ç¶œåˆæ ¼é»</button>
            <div class="cat">ç‰¹æ®ŠåŠŸèƒ½</div>
            <button class="btn-t" onclick="hAdd('datetime')">ğŸ“… æ—¥æœŸ & æ™‚é–“</button>
            <button class="btn-t" onclick="hAdd('shift')">ğŸ•’ ç­åˆ¥</button>
            <button class="btn-t" onclick="hAdd('header')">ğŸš© ç« ç¯€æ¨™é¡Œ</button>
        </div>
        <div style="padding:15px; border-top:1px solid var(--border)">
            <input type="file" id="jsonUp" style="display:none;" onchange="hImport(this)">
            <button class="btn-main" style="background:#fff; border:1px solid #ccc; margin-bottom:8px;" onclick="document.getElementById('jsonUp').click()">ğŸ“‚ åŒ¯å…¥ JSON</button>
            <button class="btn-main btn-blue" onclick="hExport()">ğŸš€ åŒ¯å‡º JSON</button>
        </div>
    </div>

    <div class="canvas-area">
        <div class="canvas-container">
            <div class="meta-card" id="formMetaCard" onmousedown="select('form_meta')">
                <textarea id="mT" class="title-inp no-drag" rows="1" style="font-size:1.8rem; font-weight:bold;" oninput="autoResize(this); syncMeta()" onfocus="select('form_meta')">æœªå‘½åçš„è¡¨å–®</textarea>
                <textarea id="mD" class="title-inp no-drag" rows="1" style="margin-top:10px; font-size:14px; font-weight:normal; display:none;" placeholder="è¼¸å…¥è¡¨å–®èªªæ˜..." oninput="autoResize(this); syncMeta()" onfocus="select('form_meta')"></textarea>
            </div>
            <div id="fList" class="sortable-list"></div>
            <div id="formFooter" class="footer-actions"></div>
        </div>
    </div>

    <div class="sidebar-r">
        <h3>å±¬æ€§è¨­å®š</h3>
        <div id="noSel" style="text-align:center; color:#999; margin-top:50px;">é»é¸æ¬„ä½æˆ–æ¨™é¡Œé–‹å§‹ç·¨è¼¯</div>
        
        <div id="formSettings" style="display:none;">
            <div class="p-item">
                <div style="margin-top:5px; border-bottom:1px dashed #eee; padding-bottom:10px; margin-bottom:10px;">
                    <label style="font-size:12px; color:#666;">æ¨™é¡Œèˆ‡æ–‡å­—æ¨£å¼</label>
                    <div class="p-row-flex">
                        <input type="number" class="inp-p" id="mSize" style="width:50px" value="28" oninput="applyGlobal()">
                        <div id="metaPaletteContainer" style="display:flex; gap:2px;"></div> 
                        <button class="biu-btn" id="mB" onclick="toggleMetaStyle('bold')">B</button>
                        <button class="biu-btn" id="mI" onclick="toggleMetaStyle('italic')">I</button>
                        <button class="biu-btn" id="mU" onclick="toggleMetaStyle('underline')">U</button>
                    </div>
                </div>
                <label class="p-check-row" style="margin-top:10px;"><input type="checkbox" id="gMetaDescE" onchange="applyGlobal()"> å•Ÿç”¨èªªæ˜æ–‡å­—</label>
            </div>

            <div class="p-item sec-divider">
                <label>æ’ç‰ˆè¨­å®š</label>
                <select class="inp-p" id="gLayout" onchange="applyGlobal()">
                    <option value="horizontal">æ©«å¼ (æ¨™é¡Œåœ¨åˆ—, å…§å®¹åœ¨ä¸‹)</option>
                    <option value="vertical">ç›´å¼ (æ¨™é¡Œåœ¨æ¬„, å…§å®¹åœ¨å³)</option>
                </select>
                
                <div class="p-row-flex" style="margin-top:8px;">
                    <label style="font-size:12px; flex:1;">æ¨™é¡Œèµ·å§‹ (Row/Col)</label>
                    <input type="number" class="inp-p" style="flex:1;" id="gTitleIdx" value="1" oninput="applyGlobal()">
                </div>
                <div class="p-row-flex">
                    <label style="font-size:12px; flex:1;">è³‡æ–™èµ·å§‹ (Row/Col)</label>
                    <input type="number" class="inp-p" style="flex:1;" id="gDataIdx" value="2" oninput="applyGlobal()">
                </div>
            </div>
            <div class="p-item sec-divider">
                <label>é€å‡ºèˆ‡æš«å­˜è¨­å®š</label>
                <label class="p-check-row"><input type="checkbox" id="gEnableTemp" onchange="applyGlobal()"> å•Ÿç”¨æš«å­˜ç´€éŒ„åˆ—è¡¨</label>
                <div id="tempConfigBtn" style="display:none; margin-top:8px;">
                     <button class="btn-main" style="background:#e8f0fe; color:#1a73e8; border:1px solid #d2e3fc;" onclick="openTempModal()">âš™ï¸ è¨­å®šæš«å­˜èˆ‡çµ±è¨ˆè¦å‰‡</button>
                </div>
            </div>
        </div>

        <div id="editor" style="display:none;">
            <div class="p-item">
                <label>æ¨™é¡Œèˆ‡æ–‡å­—æ¨£å¼</label>
                <div class="p-row-flex">
                    <input type="number" class="inp-p" id="pSize" style="width:50px" oninput="apply()">
                    <div id="editorPaletteContainer" style="display:flex; gap:2px;"></div>
                    <button class="biu-btn" id="bB" onclick="toggleStyle('bold')">B</button>
                    <button class="biu-btn" id="bI" onclick="toggleStyle('italic')">I</button>
                    <button class="biu-btn" id="bU" onclick="toggleStyle('underline')">U</button>
                </div>
            </div>

            <div class="p-item">
                <label>å¯¬åº¦èˆ‡æ’åˆ—</label>
                <div class="p-row-flex">
                    <select class="inp-p" id="pWidth" style="width:100%" onchange="apply()">
                        <option value="w-100">100% å…¨å¯¬</option>
                        <option value="w-50">50% åŠå¯¬</option>
                        <option value="w-33">33% 1/3å¯¬</option>
                    </select>
                </div>
                <label class="p-check-row" style="margin-top:5px;"><input type="checkbox" id="pDescE" onchange="apply()"> å•Ÿç”¨èªªæ˜æ–‡å­—</label>
                <label class="p-check-row" style="margin-top:5px;"><input type="checkbox" id="pReq" onchange="apply()"> å¿…å¡«é …ç›® (*)</label>
            </div>

            <div id="customRowSec" class="p-item sec-divider" style="display:none; background:#f0f9ff; padding:10px; border-radius:6px;">
                <label>è‡ªè¨‚çµ„åˆå…ƒä»¶ <span class="info-icon" data-msg="å»ºç«‹è‡ªç”±çµ„åˆçš„å–®è¡Œæ¬„ä½ã€‚<br>æ•¸å€¼è¼¸å…¥æ¡†ç”¨æ–¼è¨­å®šå…ƒä»¶çš„å¯¬åº¦(px)ã€‚">?</span></label>
                <div style="font-size:11px; color:#666; margin-bottom:5px;">é»æ“Šä¸‹æ–¹æŒ‰éˆ•åŠ å…¥å…ƒä»¶è‡³å–®è¡Œï¼š</div>
                <div style="display:flex; gap:5px; margin-bottom:10px;">
                    <button class="biu-btn" onclick="addCustomElem('check')">+å‹¾é¸</button>
                    <button class="biu-btn" onclick="addCustomElem('text')">+æ¨™ç±¤</button>
                    <button class="biu-btn" onclick="addCustomElem('input')">+è¼¸å…¥æ¡†</button>
                </div>
                <div id="customElemList"></div>
            </div>

            <div id="machineSec" class="p-item sec-divider" style="display:none;">
                <label>æ©Ÿå°é¡¯ç¤ºæ¨£å¼</label>
                <select class="inp-p" id="pMachineStyle" onchange="apply()">
                    <option value="dropdown">ä¸‹æ‹‰å¼é¸å–®</option>
                    <option value="radio">å–®é¸</option>
                    <option value="checkbox">å¤šé¸</option>
                    <option value="text">æ–‡å­—æ¡†</option>
                    <option value="mixed-radio">æ··åˆå–®é¸ (åœ“éˆ•+æ–‡å­—)</option>
                    <option value="mixed-checkbox">æ··åˆå¤šé¸ (æ–¹æ¡†+æ–‡å­—)</option>
                </select>

                <div style="margin-top:10px; background:#f0f9ff; padding:10px; border-radius:6px; font-size:12px; color:#444;">
                    <label style="margin:0 0 5px 0;">æ™ºæ…§é€£å‹•è¦å‰‡</label>
                    <div id="mRules"></div>
                    <span class="add-link" onclick="addMachineRule()">+ æ–°å¢é€£å‹•è¦å‰‡</span>
                </div>
            </div>

            <div id="modeSec" class="p-item sec-divider">
                <label>é¸æ“‡æ¨¡å¼</label>
                <select class="inp-p" id="pMode" onchange="apply()">
                    <option value="radio">å–®é¸æ¨¡å¼</option>
                    <option value="checkbox">å¤šé¸æ¨¡å¼</option>
                    <option value="mixed-radio">æ··åˆå–®é¸ (åœ“éˆ•+æ–‡å­—)</option>
                    <option value="mixed-checkbox">æ··åˆå¤šé¸ (æ–¹æ¡†+æ–‡å­—)</option>
                </select>
            </div>

            <div id="markStyleSec" class="p-item sec-divider" style="display:none; margin-top:10px;">
                <label>æ¨™è¨˜æ¨£å¼</label>
                <select class="inp-p" id="pMarkStyle" onchange="apply()">
                    <option value="mark-check">æ‰“å‹¾ (é è¨­)</option>
                    <option value="mark-cross">æ‰“å‰</option>
                    <option value="mark-both">ä¸‰æ…‹ (ç©º/å‹¾/å‰)</option>
                </select>
            </div>

            <div id="optSec" class="p-item sec-divider" style="display:none;">
                <label>é¸é …ç®¡ç†</label>
                <div id="optLayoutRow" style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                    <span style="font-size:12px; color:#666;">æ’åˆ—æ–¹å‘:</span>
                    <select id="pOptLayout" style="font-size:12px; padding:2px;" onchange="apply()">
                        <option value="vertical">ç›´å¼ (å‚ç›´)</option>
                        <option value="horizontal">æ©«å¼ (æ°´å¹³)</option>
                    </select>
                </div>
                <div id="optList"></div>
                <div style="display:flex; gap:10px;">
                    <span class="add-link" onclick="addSidebarOpt()">+ æ–°å¢é¸é …</span>
                    <span class="add-link" onclick="bulkAddSidebarOpt()">+ æ‰¹é‡æ–°å¢</span>
                </div>
            </div>
            
            <div id="optSecLocked" class="p-item sec-divider" style="display:none; background:#fff3cd; padding:8px; border:1px solid #ffeeba; border-radius:4px; color:#856404; font-size:12px;">
                âš ï¸ æ­¤æ¬„ä½é¸é …ç”±ã€Œæ©Ÿå°é€£å‹•è¦å‰‡ã€æ§åˆ¶ï¼Œè«‹è‡³å°æ‡‰çš„æ©Ÿå°æ¬„ä½è¨­å®šè¦å‰‡ã€‚
            </div>

            <div id="gridSec" class="p-item sec-divider" style="display:none;">
                <label style="margin-bottom:5px;">æ ¼é»è¨­å®š</label>
                <label class="p-check-row"><input type="checkbox" id="pCorner" onchange="apply()"> é¡¯ç¤ºæ–œç·šè¡¨é ­</label>
                <label class="p-check-row"><input type="checkbox" id="pShowCol" onchange="apply()"> é¡¯ç¤ºæ¬„æ¨™é¡Œ</label>
                <label class="p-check-row"><input type="checkbox" id="pShowRow" onchange="apply()"> é¡¯ç¤ºåˆ—æ¨™é¡Œ</label>
            </div>

            <div id="contentSec" class="p-item sec-divider">
                <label>å…§å®¹é™åˆ¶èˆ‡æ ¼å¼</label>
                <label class="p-check-row"><input type="checkbox" id="pUpperCase" onchange="apply()"> é¡¯ç¤ºå¤§å¯«</label>
                <div id="defValRow">
                    <input type="text" class="inp-p" id="pLink" placeholder="æ’å…¥é€£çµ (URL)" oninput="apply()" style="margin-bottom:6px;">
                    <input type="text" class="inp-p" id="pDefVal" placeholder="é è¨­å€¼" oninput="apply()" style="margin-bottom:6px;">
                </div>
            
                <div style="margin-top:10px; background:#fff3e0; padding:8px; border-radius:4px; border:1px solid #ffe0b2;">
                    <label style="margin-bottom:4px; color:#e65100;">å…§å®¹é©—è­‰è¦å‰‡</label>
                    <div id="valRulesList"></div>
                    <div style="display:flex; gap:5px; margin-top:5px;">
                         <span class="add-link" style="margin-top:2px;" onclick="addValRule()">+ æ–°å¢è¦å‰‡</span>
                    </div>
                </div>
            </div>

            <div id="unitSec" class="p-item sec-divider" style="display:none;">
                <div class="header-split">
                    <label style="margin:0;">
                        å–®ä½å¸¶å…¥èˆ‡è¦å‰‡
                        <span class="info-icon" data-msg="è¨­å®šæ•¸å€¼åˆ¤å®šè¦å‰‡ã€‚ä¾‹å¦‚ï¼šç•¶è¼¸å…¥å€¼ > 10 æ™‚ï¼Œè‡ªå‹•åˆ¤å®šç‚º 'åˆæ ¼' ä¸¦å¸¶å…¥çµæœã€‚">?</span>
                    </label>
                    <label class="header-right-check"><input type="checkbox" id="pManual" onchange="apply()"> å…è¨±æ‰‹å‹•è®Šæ›´</label>
                </div>
                <label class="p-check-row"><input type="checkbox" id="pUnitE" onchange="apply()"> å–®ä½</label>
                <input type="text" class="inp-p" id="pUnitB" placeholder="é è¨­å–®ä½ (å¦‚ pcs)" oninput="updateUnitB(this.value)">
                
                <div id="uLogic" class="logic-panel" style="display:none;">
                    <div id="uRules"></div>
                    <span class="add-link" onclick="addURule()">+ æ–°å¢æ¢ä»¶è¦å‰‡</span>
                </div>
            </div>

            <div id="shiftSec" class="p-item sec-divider" style="display:none;">
                <label>é¡¯ç¤ºæ¨£å¼</label>
                <select class="inp-p" id="pShiftStyle" onchange="apply()">
                    <option value="dropdown">ä¸‹æ‹‰å¼é¸å–®</option>
                    <option value="radio">å–®é¸</option>
                </select>
                <label style="margin-top:10px; font-weight:bold; font-size:13px;">æ™ºæ…§åŒ–å¸¶å…¥</label>
                <label class="p-check-row"><input type="checkbox" id="pShiftLogicE" onchange="apply()"> å•Ÿç”¨æ™ºæ…§å¸¶å…¥</label>
                <div style="background:#f0f9ff; padding:10px; border-radius:6px; font-size:12px; color:#444; margin-top:5px;">
                    <div id="sRules"></div>
                    <span class="add-link" onclick="addShiftRule()">+ æ–°å¢æ™‚é–“å€æ®µ</span>
                </div>
                <label class="p-check-row" style="margin-top:10px;"><input type="checkbox" id="pAutoPrev" onchange="apply()"> è‡ªå‹•å¸¶å…¥å‰ä¸€ç­†è³‡æ–™</label>
            </div>

            <div id="dateSec" class="p-item sec-divider" style="display:none;">
                <label>æ—¥æœŸèˆ‡æ™‚é–“è¨­å®š</label>
                <label class="p-check-row"><input type="checkbox" id="pShowTime" onchange="apply()"> é¡¯ç¤ºæ™‚é–“é¸æ“‡</label>
                <label class="p-check-row"><input type="checkbox" id="pAutoDate" onchange="apply()"> è‡ªå‹•å¸¶å…¥ç•¶å‰æ—¥æœŸ</label>
                <label class="p-check-row"><input type="checkbox" id="pAutoTime" onchange="apply()"> è‡ªå‹•å¸¶å…¥ç•¶å‰æ™‚é–“</label>
                <label class="p-check-row"><input type="checkbox" id="pDateOffset" onchange="apply()"> è·¨æ—¥è¨­å®š (æ—¥æœŸ-1)</label>
            </div>
            
            <div id="autoPrevSec" class="p-item sec-divider">
                <label>
                    è‡ªå‹•å¸¶å…¥è¦å‰‡ 
                    <span class="info-icon" data-msg="è¨­å®šæ™‚æ®µå€é–“ï¼ˆå¦‚ 08:00~16:00ï¼‰ï¼Œåœ¨æ­¤å€é–“å…§æ–°è³‡æ–™æœƒè‡ªå‹•å¸¶å…¥ä¸Šä¸€ç­†ã€‚">?</span>
                </label>
                <div style="background:#f0f9ff; padding:10px; border-radius:6px; font-size:12px; color:#444; margin-top:5px;">
                    <div id="apRules"></div>
                    <span class="add-link" onclick="addAutoPrevRule()">+ æ–°å¢è‡ªå‹•å¸¶å…¥å€æ®µ</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        /* [CORE VARIABLES] */
        let fields = [];
        let activeId = null;
        let formConfig = { 
            layout: 'horizontal', titleIdx: 1, dataIdx: 2, 
            enableTemp: false, clearOnSubmit: false, metaDescE: false,
            metaStyle: { size: 28, color: '#000000', bgColor: 'transparent', bold: true, width: 'w-100' },
            tempColIds: [], calcCols: [], clearTimes: [] 
        };
        let mockTempData = [];
        let isPreviewMode = false;
        
        const list = document.getElementById('fList');
        let tempModalState = { tempColIds: [], calcCols: [], clearTimes: [], clearOnSubmit: false };

        /* Palette Code */
        const getPaletteHTML = (idPrefix, targetType, currentColor, indicatorId) => `
            <div style="position:relative; z-index:50;">
                <div class="palette-btn" onclick="togglePalette('${idPrefix}', event)" title="${targetType==='text'?'æ–‡å­—é¡è‰²':'æ–‡å­—èƒŒæ™¯'}">
                    <div class="palette-icon-wrap">
                        ${targetType==='text' 
                            ? `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 20L12 4l8 16"></path><path d="M4 20h16"></path><path d="M8.5 13h7"></path></svg>`
                            : `<svg width="14" height="14" viewBox="0 0 24 24" fill="#555"><path d="M16.56 8.94L7.62 0 6.21 1.41l2.38 2.38-5.15 5.15c-.59.59-.59 1.54 0 2.12l5.5 5.5c.29.29.68.44 1.06.44s.77-.15 1.06-.44l5.5-5.5c.59-.58.59-1.53 0-2.12zM5.21 10L10 5.21 14.79 10H5.21zM19 11.5s-2 2.17-2 3.5c0 1.1.9 2 2 2s2-.9 2-2c0-1.33-2-3.5-2-3.5z"></path><path fill-opacity=".36" d="M0 20h24v4H0z"></path></svg>`}
                        <div id="${indicatorId}" class="palette-color-bar" style="background:${currentColor};"></div>
                    </div>
                    <span class="palette-arrow">â–¼</span>
                </div>
                <div id="pal${idPrefix}" class="palette-popover">
                    <div class="palette-title">${targetType==='text'?'æ–‡å­—é¡è‰²':'æ–‡å­—èƒŒæ™¯'}</div>
                    <div class="color-cell ${targetType==='bg'?'transparent':''}" style="width:100%; text-align:center; font-size:11px; line-height:24px; border:1px solid #ddd; margin-bottom:6px;" onclick="updateColor('${targetType}','${targetType==='bg'?'transparent':'#000000'}', '${idPrefix}')">${targetType==='bg'?'ç„¡å¡«æ»¿':'è‡ªå‹• (é»‘è‰²)'}</div>
                    <div class="palette-title">åŸºæœ¬è‰²</div>
                    <div class="color-grid">
                        ${['#000000','#ffffff','#eeece1','#1f497d','#4f81bd','#c0504d','#9bbb59','#8064a2','#4bacc6','#f79646'].map(c => 
                            `<div class="color-cell" style="background:${c}; ${c==='#ffffff'?'border:1px solid #ccc;':''}" onclick="updateColor('${targetType}','${c}', '${idPrefix}')"></div>`
                        ).join('')}
                    </div>
                    <div class="palette-title">å¸¸ç”¨è‰²</div>
                    <div class="color-grid">
                        ${['#c00000','#ff0000','#ffc000','#ffff00','#92d050','#00b050','#00b0f0','#0070c0','#002060','#7030a0'].map(c => 
                            `<div class="color-cell" style="background:${c};" onclick="updateColor('${targetType}','${c}', '${idPrefix}')"></div>`
                        ).join('')}
                    </div>
                    <label class="palette-custom-row">
                        <div class="custom-color-icon"></div>
                        <span>è‡ªè¨‚é¡è‰²...</span>
                        <input type="color" style="position:absolute; opacity:0; left:0; width:100%; bottom:0; height:30px; cursor:pointer;" oninput="updateColor('${targetType}', this.value, '${idPrefix}')">
                    </label>
                </div>
            </div>`;

        try {
            new Sortable(list, {
                animation: 150, handle: '.card', filter: '.no-drag, input, textarea, button, select, span, .opt-item, .fake-icon, .grid-add-btn', preventOnFilter: false,
                onEnd: () => {
                    const order = Array.from(list.children).map(el => el.dataset.id);
                    fields = order.map(id => fields.find(x => x.id === id)).filter(Boolean);
                }
            });
        } catch(e) {}

        document.addEventListener('click', function(e) {
            if(!e.target.closest('.palette-btn') && !e.target.closest('.palette-popover')) {
                document.querySelectorAll('.palette-popover').forEach(p => p.classList.remove('active'));
            }
            if(!e.target.closest('.ms-container')) {
                document.querySelectorAll('.ms-dropdown').forEach(d => d.classList.remove('active'));
            }
            if(!e.target.closest('.unit-label-container') && !e.target.closest('.unit-dropdown-menu')) {
                document.querySelectorAll('.unit-dropdown-menu').forEach(d => d.classList.remove('active'));
            }
        });
        function togglePalette(id, event) {
            if(event) event.stopPropagation();
            const pop = document.getElementById('pal'+id);
            if(!pop) return;
            document.querySelectorAll('.palette-popover').forEach(p => { if(p.id!=='pal'+id) p.classList.remove('active'); });
            pop.classList.toggle('active');
        }
        function updateColor(type, color, idPrefix) {
            document.getElementById('ind'+idPrefix).style.backgroundColor = color;
            if (idPrefix.startsWith('rule')) {
                 const index = parseInt(idPrefix.replace('rule',''));
                 updateModalCalc(index, 'ruleColor', color);
            } else if(activeId === 'form_meta') {
                if(!formConfig.metaStyle) formConfig.metaStyle = {};
                if(type === 'text') formConfig.metaStyle.color = color;
                if(type === 'bg') formConfig.metaStyle.bgColor = color;
                render();
            } else {
                const f = fields.find(x => x.id === activeId);
                if(f) {
                    if(type === 'text') f.color = color;
                    if(type === 'bg') f.bgColor = color;
                    render(); 
                }
            }
            document.querySelectorAll('.palette-popover').forEach(p => p.classList.remove('active'));
        }

        /* --- Helper Functions --- */
        document.addEventListener('mouseover', function(e) {
            if (e.target.classList.contains('info-icon')) {
                const msg = e.target.getAttribute('data-msg');
                const tip = document.createElement('div');
                tip.className = 'global-tooltip';
                tip.innerHTML = msg; 
                document.body.appendChild(tip);
                const rect = e.target.getBoundingClientRect();
                tip.style.top = (rect.bottom + 5) + 'px';
                tip.style.right = (window.innerWidth - rect.left + 5) + 'px'; 
            }
        });
        document.addEventListener('mouseout', function(e) {
            if (e.target.classList.contains('info-icon')) {
                document.querySelectorAll('.global-tooltip').forEach(t => t.remove());
            }
        });
        
        function sanitizeField(f) {
            if(!f.opts) f.opts = ['é¸é … 1'];
            if(!f.cols) f.cols = ['ç¬¬ 1 æ¬„'];
            if(!f.rows) f.rows = ['ç¬¬ 1 åˆ—'];
            if(!f.colModes) f.colModes = ['text']; 
            if(!f.machineRules) f.machineRules = [];
            if(!f.shiftRules) f.shiftRules = [];
            if(!f.autoPrevRules) f.autoPrevRules = [];
            if(!f.uRules) f.uRules = [];
            if(!f.valRules) f.valRules = []; 
            if(!f.bgColor) f.bgColor = 'transparent';
            if(!f.markStyle) f.markStyle = 'mark-check';
            if(!f.optLayout) f.optLayout = 'vertical';
            if(f.type === 'grid') {
                if(!f.cellModes || f.cellModes.length !== f.rows.length) {
                    f.cellModes = f.rows.map(() => f.colModes ? [...f.colModes] : new Array(f.cols.length).fill('text'));
                }
                if(f.showCol === undefined) f.showCol = true;
                if(f.showRow === undefined) f.showRow = true;
                if(f.corner === undefined) f.corner = true;
            }
            while(f.colModes.length < f.cols.length) f.colModes.push('text');
            return f;
        }

        function createFieldModel(type) {
             const id = 'f' + Date.now();
             let title = (type==='batch')?'æ‰¹è™Ÿ':(type==='shift')?'ç­åˆ¥':(type==='datetime')?'æ—¥æœŸ':(type==='machine')?'æ©Ÿå°':(type==='remark')?'å‚™è¨»':'æœªå‘½åçš„å•é¡Œ';
             if(type==='header') title='ç« ç¯€æ¨™é¡Œ';
             if(type==='custom_row') title='è‡ªè¨‚çµ„åˆ';

             const f = {
                id, type, title, width:'w-100', size:14, color:'#000000', bgColor: 'transparent', bold:false, italic:false, underline:false,
                req:false, descE:false, desc:'', unitB:'', uEnable:false, uRules: [], 
                mode:'text', manual:false,
                rows:['ç¬¬ 1 åˆ—'], cols:['ç¬¬ 1 æ¬„'], colModes: ['text'], cellModes: [['text']],
                corner:true, cornerTop:'æ¬„å', cornerBot:'åˆ—å', showCol:true, showRow:true,
                opts:['é¸é … 1'], optLayout:'vertical', testV:'', link:'', upper:false, defVal:'', 
                valRules: [], 
                shiftStyle: 'dropdown', shiftLogicE: false, shiftRules: [], 
                autoPrevRules: [], showTime: false, autoDate: false, autoTime: false, dateOffset: false,
                markStyle: 'mark-check', machineStyle: 'dropdown', machineRules: [],
                customElems: type==='custom_row' ? [{type:'check', label:'æª¢æŸ¥'}, {type:'input', width:100, placeholder:'æ•¸å€¼'}] : []
             };
             if(type === 'choices') f.mode = 'radio';
             if(type === 'shift') f.opts = ['æ—©ç­', 'æ™šç­'];
             if(type === 'machine') f.opts = ['æ©Ÿå° 1'];
             return f;
        }

        function hAdd(type) {
            const f = createFieldModel(type);
            if(activeId && activeId !== 'form_meta') {
                const idx = fields.findIndex(x => x.id === activeId);
                fields.splice(idx+1, 0, f);
            } else fields.push(f);
            render(); setTimeout(() => select(f.id), 50);
        }

        /* --- Render Logic --- */
        function render() {
            const mS = formConfig.metaStyle || { size: 28, color: '#000000', bgColor: 'transparent', bold: true, width: 'w-100' };
            const mCard = document.getElementById('formMetaCard');
            if(mCard) {
                mCard.className = `meta-card ${mS.width || 'w-100'} ${activeId==='form_meta'?'selected':''}`;
                const mT = document.getElementById('mT');
                mT.style.fontSize = mS.size + 'px';
                mT.style.color = mS.color;
                mT.style.backgroundColor = mS.bgColor;
                mT.style.fontWeight = mS.bold ? 'bold' : 'normal';
                mT.style.fontStyle = mS.italic ? 'italic' : 'normal';
                mT.style.textDecoration = mS.underline ? 'underline' : 'none';
                document.getElementById('mD').style.display = formConfig.metaDescE ? 'block' : 'none';
            }

            const htmlArr = fields.map(f => {
                try {
                    sanitizeField(f);
                    const s = `font-size:${f.size}px; color:${f.color}; background-color:${f.bgColor}; font-weight:${f.bold?'bold':'normal'}; font-style:${f.italic?'italic':'normal'}; text-decoration:${f.underline?'underline':'none'};`;
                    
                    const renderInput = (cls, ph, valOverride, maxLen) => 
                        `<input class="${cls} no-drag" style="width:100%; border:1px solid #ccc; border-radius:4px; padding:4px 6px; font-size:12px; height:28px; outline:none; background:#fff; ${f.upper ? 'text-transform:uppercase;' : ''}" placeholder="${ph}" oninput="validateInput(this, '${f.id}')" onblur="handleBlur(this, '${f.id}')" onfocus="select('${f.id}')" data-fid="${f.id}" value="${valOverride !== undefined ? valOverride : (f.defVal || '')}" ${maxLen ? `maxlength="${maxLen}"` : ''}>`;
                    
                    const isChecked = (val) => {
                         if(!f.testV) return false;
                         return f.testV.split(',').includes(val);
                    };

                    /* Fix 5: Ensure Tri-state and Cross marks render correctly */
                    const renderMark = (isRadio, customMarkStyle, valName) => {
                        let checkedClass = '';
                        if(isChecked(valName)) checkedClass = 'checked-v';
                        if(isChecked(valName + '_NG')) checkedClass = 'checked-x';
                        
                        // For non-tri-state (just cross), convert V to X if that's the style
                        if(customMarkStyle === 'mark-cross' && checkedClass === 'checked-v') checkedClass = 'checked-x';

                        return `<div class="fake-icon ${isRadio?'radio':'checkbox'} ${checkedClass} no-drag" onclick="toggleCheck(this, '${customMarkStyle || f.markStyle}', ${isRadio}, '${f.id}', '${valName}')"></div>`;
                    };

                    let uiHints = '';
                    if (['choices', 'machine'].includes(f.type)) {
                        let ms = (f.type==='machine') ? f.machineStyle : f.mode;
                        let mark = f.markStyle;
                        if(ms.includes('radio') || ms === 'dropdown') uiHints += `<span class="ui-hint-badge">å–®é¸</span>`;
                        if(ms.includes('checkbox')) uiHints += `<span class="ui-hint-badge">å¤šé¸</span>`;
                        if (ms !== 'dropdown' && ms !== 'text') {
                            if(mark === 'mark-check') uiHints += `<span class="ui-hint-badge">æ‰“å‹¾</span>`;
                            else if(mark === 'mark-cross') uiHints += `<span class="ui-hint-badge">æ‰“å‰</span>`;
                            else if(mark === 'mark-both') uiHints += `<span class="ui-hint-badge">ä¸‰æ…‹</span>`;
                        }
                    }

                    let autoPrevBadge = '';
                    if((f.autoPrevRules || []).length > 0) {
                        const times = f.autoPrevRules.map(r => `${r.start}~${r.end}`).join(', ');
                        autoPrevBadge = `<div style="font-size:11px; color:#0284c7; background:#e0f2fe; padding:2px 6px; border-radius:4px; margin-bottom:4px; width:fit-content;">ğŸ”„ è‡ªå‹•å¸¶å…¥å‰ç­† ${times}</div>`;
                    }

                    let body = '';
                    if(f.type === 'batch') body = `<div class="batch-container"><label class="batch-label" onclick="event.stopPropagation()"><div class="fake-icon checkbox no-drag ${isChecked('FA')?'checked-v':''}" onclick="toggleBatchFA('${f.id}')"></div> FA</label>${renderInput('batch-input-flex', 'ä¸»æ‰¹è™Ÿ(3)', undefined, 3)}<span>-</span>${renderInput('batch-input-flex', 'å­æ‰¹è™Ÿ(2)', undefined, 2)}</div>`;
                    else if(f.type === 'custom_row') {
                        body = `<div class="batch-container">
                            ${(f.customElems||[]).map(el => {
                                if(el.type==='check') return `<label class="batch-label" onclick="event.stopPropagation()"><div class="fake-icon checkbox no-drag ${isChecked(el.label)?'checked-v':''}" onclick="toggleCheck(this, 'mark-check', false, '${f.id}', '${el.label}')"></div> ${el.label||''}</label>`;
                                if(el.type==='text') return `<span style="font-size:13px; font-weight:bold; margin:0 4px;">${el.label||''}</span>`;
                                if(el.type==='input') return `<div style="flex:${el.flex?1:'none'}; width:${el.width||80}px;">${renderInput('batch-input-flex', el.placeholder||'', undefined)}</div>`;
                            }).join('')}
                        </div>`;
                    }
                    else if(f.type === 'machine') {
                        if(f.machineStyle === 'dropdown') {
                            body = `${autoPrevBadge}<div class="preview-dropdown" onclick="select('${f.id}')"><select class="no-drag" style="width:100%; border:none; background:transparent;" onchange="runMachineLogic('${f.id}', this.value)"><option>-- è«‹é¸æ“‡æ©Ÿå° --</option>${(f.opts||[]).map(o=>`<option value="${o}" ${f.testV===o?'selected':''}>${o}</option>`).join('')}</select></div>`;
                        } else if(f.machineStyle === 'text') {
                            body = `${autoPrevBadge}<div style="display:flex; border:1px solid #ccc; border-radius:4px;">${renderInput('style-v27-box','è«‹è¼¸å…¥æ©Ÿå°åç¨±...')}</div>`;
                        } else {
                            body = `${autoPrevBadge}<div class="opt-container ${f.optLayout||'vertical'}">${(f.opts||[]).map(o=> {
                                const isMixed = f.machineStyle.startsWith('mixed');
                                const isRadio = f.machineStyle.includes('radio');
                                const mark = renderMark(isRadio, f.markStyle, o);
                                const input = isMixed ? renderInput('style-v27-box','') : '';
                                return `<div class="opt-item" onclick="select('${f.id}'); runMachineLogic('${f.id}', '${o}')">${mark} <span>${o}</span> ${input}</div>`;
                            }).join('')}</div>`;
                        }
                        if((f.machineRules||[]).length > 0) {
                            const ruleText = f.machineRules.map(r=> `<span style="font-size:10px; background:#eee; padding:1px 3px;">${r.val}â†’${r.target.split(',').length}æ¬„ä½</span>`).join(' ');
                            body = `<div style="font-size:11px; color:#888; margin-bottom:4px;">é€£å‹•è¦å‰‡ ${ruleText}</div>` + body;
                        }
                    } else if(f.type === 'shift') {
                        if(f.shiftStyle === 'radio') body = `${autoPrevBadge}<div class="opt-container ${f.optLayout||'vertical'}">${(f.opts||[]).map(o=>`<label class="opt-item" onclick="select('${f.id}')">${renderMark(true, 'mark-check', o)} <span>${o}</span></label>`).join('')}</div>`;
                        else body = `${autoPrevBadge}<div class="preview-dropdown" onclick="select('${f.id}')"><select class="no-drag" style="width:100%; border:none; background:transparent;"><option>-- è«‹é¸æ“‡ç­åˆ¥ --</option>${(f.opts||[]).map(o=>`<option>${o}</option>`).join('')}</select></div>`;
                        if(f.shiftLogicE) body = `<span style="font-size:11px; color:#1a73e8; background:#e8f0fe; padding:2px;">âš¡ æ™ºæ…§å¸¶å…¥</span> ` + body;
                    } else if(f.type === 'datetime') body = `<div style="display:flex; gap:10px;" onclick="select('${f.id}')"><div style="border:1px solid #ccc; padding:6px; flex:1; border-radius:4px; background:#fff;">YYYY/MM/DD ğŸ“…</div>${f.showTime?'<div style="border:1px solid #ccc; padding:6px; width:80px; border-radius:4px; background:#fff;">--:-- ğŸ•’</div>':''}</div>`;
                    else if(f.type === 'remark') body = `${autoPrevBadge}<textarea class="remark-box no-drag" placeholder="å‚™è¨»..." onclick="select('${f.id}')">${f.defVal || ''}</textarea>`;
                    else if(f.type === 'grid') {
                         let thead = '';
                         if(f.showCol) {
                            let headerCell = f.corner && f.showRow ? `<th class="slash-header"><input class="slash-top no-drag" value="${f.cornerTop}" placeholder="æ¬„" onfocus="select('${f.id}')"><input class="slash-bot no-drag" value="${f.cornerBot}" placeholder="åˆ—" onfocus="select('${f.id}')"></th>` : (f.showRow ? `<th></th>` : '');
                            const ths = f.cols.map((c,i) => `<th><div style="display:flex;align-items:center;justify-content:center;position:relative;"><span class="grid-header-mode-icon no-drag" onclick="cycleGridColMode('${f.id}', ${i})" title="åˆ‡æ›æ­¤æ¬„æ¨¡å¼">${getIconForMode(f.cellModes[0] ? f.cellModes[0][i] : 'text')}</span><input class="grid-inp no-drag" value="${c}" onchange="syncGridCol('${f.id}',${i},this.value)" onfocus="select('${f.id}')"><span class="del-col-btn no-drag" onclick="delCol('${f.id}',${i})">Ã—</span></div></th>`).join('');
                            thead = `<thead><tr>${headerCell}${ths}<th class="grid-add-btn grid-add-col no-drag" onclick="addCol('${f.id}')">+</th></tr></thead>`;
                         }
                         const trs = f.rows.map((r,i) => {
                             const rowHeader = f.showRow ? `<td><div style="display:flex;align-items:center;justify-content:center;position:relative;"><span class="grid-header-mode-icon no-drag" onclick="cycleGridRowMode('${f.id}', ${i})" title="åˆ‡æ›æ­¤åˆ—æ¨¡å¼" style="left:-2px;">${getIconForMode(f.cellModes[i] ? f.cellModes[i][0] : 'text')}</span><input class="grid-inp no-drag" value="${r}" onchange="syncGridRow('${f.id}',${i},this.value)" onfocus="select('${f.id}')"><span class="del-row-btn no-drag" onclick="delRow('${f.id}',${i})">ğŸ—‘</span></div></td>` : '';
                             return `<tr>${rowHeader}${f.cols.map((c, colIndex) => {
                                 const mode = (f.cellModes && f.cellModes[i] && f.cellModes[i][colIndex]) ? f.cellModes[i][colIndex] : 'text';
                                 let inner = '';
                                 if(mode === 'text') inner = renderInput('style-v27-box','');
                                 else if(mode === 'radio') inner = `<div class="grid-cell-wrapper" onclick="select('${f.id}')">${renderMark(true, f.markStyle, r+c)}</div>`;
                                 else if(mode === 'checkbox') inner = `<div class="grid-cell-wrapper" onclick="select('${f.id}')">${renderMark(false, f.markStyle, r+c)}</div>`;
                                 else if(mode === 'mixed-radio') inner = `<div class="grid-cell-wrapper" onclick="select('${f.id}')">${renderMark(true, f.markStyle, r+c)}${renderInput('style-v27-box','')}</div>`;
                                 else if(mode === 'mixed-checkbox') inner = `<div class="grid-cell-wrapper" onclick="select('${f.id}')">${renderMark(false, f.markStyle, r+c)}${renderInput('style-v27-box','')}</div>`;
                                 return `<td>${inner}</td>`;
                             }).join('')}</tr>`;
                         }).join('');
                         const footerRow = `<tr><td colspan="${f.cols.length + (f.showRow?1:0) + 1}" class="grid-add-btn grid-add-row no-drag" onclick="addRow('${f.id}')">+</td></tr>`;
                         body = `${autoPrevBadge}<table class="grid-table">${thead}<tbody>${trs}${footerRow}</tbody></table>`;
                    } else if(f.type === 'text') {
                         let unitHtml = '';
                         if(f.uEnable) {
                             if(f.manual) {
                                 unitHtml = `<div class="unit-label-container" onclick="toggleUnitDropdown('${f.id}', event)"><div class="unit-text-display" id="unitDisplay_${f.id}">${f.unitB}</div><div class="manual-arrow">â–¼</div><div id="unitDrop_${f.id}" class="unit-dropdown-menu"></div></div>`;
                             } else {
                                 unitHtml = `<div class="unit-label-container" style="cursor:default;"><div class="unit-text-display" id="unitDisplay_${f.id}">${f.unitB}</div></div>`;
                             }
                         }
                         body = `${autoPrevBadge}<div style="display:flex; border:1px solid #ccc; border-radius:4px; overflow:visible; position:relative;">${renderInput('style-v27-box','è«‹è¼¸å…¥...')}${unitHtml}</div>`;
                    } else if(['choices','dropdown'].includes(f.type)) {
                         if(f.type==='dropdown') body = `${autoPrevBadge}<div class="preview-dropdown" onclick="select('${f.id}')"><select class="no-drag" style="width:100%; border:none; background:transparent;"><option>-- è«‹é¸æ“‡ --</option>${(f.opts||[]).map(o=>`<option>${o}</option>`).join('')}</select></div>`;
                         else {
                             if(f.mode === 'text') {
                                 body = `${autoPrevBadge}<div class="opt-container ${f.optLayout||'vertical'}">${(f.opts||[]).map(o=> {
                                     return `<div class="opt-item" onclick="select('${f.id}')"><span>${o}</span> ${renderInput('style-v27-box','')}</div>`;
                                 }).join('')}</div>`;
                             } else {
                                 body = `${autoPrevBadge}<div class="opt-container ${f.optLayout||'vertical'}">${(f.opts||[]).map(o=> {
                                        const isMixed = f.mode==='mixed-radio'||f.mode==='mixed-checkbox';
                                        const isRadio = f.mode==='radio' || f.mode==='mixed-radio';
                                        const mark = renderMark(isRadio, f.markStyle, o);
                                        const input = isMixed ? renderInput('style-v27-box','') : '';
                                        return `<div class="opt-item" onclick="select('${f.id}')">${mark} <span>${o}</span> ${input}</div>`;
                                 }).join('')}</div>`;
                             }
                         }
                    } else if(f.type === 'header') {
                        body = ``;
                    }
                    return `
                        <div class="card ${f.width} ${activeId===f.id?'selected':''}" data-id="${f.id}" onmousedown="select('${f.id}')">
                            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                                <div style="width:85%; display:flex; align-items:center; gap:4px;">
                                    <textarea class="title-inp no-drag" rows="1" style="${s} flex:1;" oninput="autoResize(this); syncTitle('${f.id}',this.value)" onfocus="select('${f.id}')">${f.title}</textarea>
                                    ${f.link ? `<a href="${f.link}" target="_blank" class="no-drag" style="text-decoration:none; margin-left:5px;">ğŸ”—</a>` : ''}
                                    ${f.req?'<span style="color:red;">*</span>':''}
                                </div>
                                <span style="font-size:10px; color:#aaa; border:1px solid #eee; padding:2px 5px; border-radius:4px; white-space:nowrap;">${f.type.toUpperCase()}${uiHints}</span>
                            </div>
                            ${f.descE?`<div style="margin-bottom:8px; font-size:12px; color:#666;"><textarea class="desc-inp no-drag" rows="1" placeholder="è¼¸å…¥èªªæ˜..." oninput="autoResize(this); syncDesc('${f.id}',this.value)" onfocus="select('${f.id}')">${f.desc || ''}</textarea></div>`:''}
                            <div>${body}</div>
                            <div class="card-tools">
                                <span class="tool-action no-drag" onclick="copyF('${f.id}')">ğŸ“‹ è¤‡è£½</span>
                                <span class="tool-action no-drag" style="color:#d93025;" onclick="delF('${f.id}')">ğŸ—‘ åˆªé™¤</span>
                            </div>
                        </div>`;
                } catch (err) { return `<div class="card w-100 error" data-id="${f.id}">âš ï¸ æ¸²æŸ“éŒ¯èª¤</div>`; }
            });
            list.innerHTML = htmlArr.join('');
            renderFooter();
        }

        /* --- Footer & Temp List Logic (Fix 1: Permanent Display) --- */
        function renderFooter() {
            const footer = document.getElementById('formFooter');
            if(!formConfig.enableTemp) {
                // æœªå•Ÿç”¨æš«å­˜ -> åªé¡¯ç¤ºé€å‡º
                footer.innerHTML = `<button class="btn-submit no-drag" onclick="mockSubmit(true)">ğŸš€ ç›´æ¥é€å‡ºè³‡æ–™ (è‡³ç¸½æª”)</button>`;
            } else {
                // å•Ÿç”¨æš«å­˜ -> é¡¯ç¤ºé»ƒè‰²æŒ‰éˆ• + åˆ—è¡¨ + ç¶ è‰²æŒ‰éˆ•
                let tempListHtml = `
                    <div class="temp-table-view no-drag">
                        <div class="temp-table-header">ğŸ“‹ ç•¶ç­æš«å­˜ç´€éŒ„ (${mockTempData.length} ç­†)</div>
                        <table class="temp-record-list">
                            <thead><tr><th>#</th><th>æ™‚é–“</th><th>æ‘˜è¦</th><th>æ“ä½œ</th></tr></thead>
                            <tbody>
                                ${mockTempData.length === 0 ? '<tr><td colspan="4" style="text-align:center; color:#999; padding:15px;">ç›®å‰æš«å­˜å€ç„¡ç´€éŒ„</td></tr>' : 
                                mockTempData.map((d, i) => `<tr>
                                    <td>${i+1}</td>
                                    <td>${d.timestamp}</td>
                                    <td>ID: ${d.id}</td>
                                    <td class="temp-actions"><span onclick="loadTemp(${i})">ç·¨è¼¯</span><span class="del" onclick="delTemp(${i})">åˆªé™¤</span></td>
                                </tr>`).join('')}
                            </tbody>
                        </table>
                    </div>`;
                
                footer.innerHTML = `
                <button class="btn-temp no-drag" onclick="mockAddToTemp()">ğŸ’¾ æš«å­˜å–®ç­†ç´€éŒ„ (åŠ å…¥ä¸‹æ–¹åˆ—è¡¨)</button>
                ${tempListHtml}
                <button class="btn-submit no-drag" style="margin-top:10px;" onclick="mockSubmit(false)">ğŸš€ æœ€çµ‚é€å‡ºæ‰€æœ‰ç´€éŒ„è‡³ Excel (æ‰‹å‹•æå‰äº¤æ¥)</button>`;
            }
        }

        function mockAddToTemp() {
            if(!checkValidation()) return;
            mockTempData.push({ id: Date.now(), timestamp: new Date().toLocaleTimeString() });
            alert(`âœ… è³‡æ–™å·²å¯«å…¥ã€Œç³»çµ±æš«å­˜å€ã€ï¼\nç›®å‰æš«å­˜ç­†æ•¸ï¼š${mockTempData.length}`);
            renderFooter();
        }

        function mockSubmit(direct) {
            if(direct) {
                 if(!checkValidation()) return;
                 alert("ğŸš€ è³‡æ–™å·²ç›´æ¥å¯«å…¥ã€Œç¸½æª”ã€ï¼");
            } else {
                if(mockTempData.length === 0) { alert("âš ï¸ æš«å­˜å€ç„¡è³‡æ–™ï¼Œç„¡æ³•é€å‡ºï¼"); return; }
                if(confirm(`ç¢ºèªå°‡ ${mockTempData.length} ç­†æš«å­˜è³‡æ–™è½‰å…¥ã€Œç¸½æª”ã€ä¸¦æ¸…ç©ºæš«å­˜å€ï¼Ÿ`)) {
                    mockTempData = [];
                    renderFooter();
                    alert("ğŸš€ ç§»è½‰å®Œæˆï¼æš«å­˜å€å·²æ¸…ç©ºã€‚");
                }
            }
        }

        function delTemp(index) {
            if(confirm("ç¢ºå®šåˆªé™¤æ­¤ç­†æš«å­˜ï¼Ÿ")) {
                mockTempData.splice(index, 1);
                renderFooter();
            }
        }

        function loadTemp(index) {
            alert("ğŸ”„ (æ¨¡æ“¬) è³‡æ–™å·²è¼‰å›è¡¨å–®ä¾›ç·¨è¼¯ã€‚");
        }

        /* --- Validation & Check Logic --- */
        function toggleBatchFA(fid) {
            // Fix 3: Special toggle for FA checkbox in Batch type
            const f = fields.find(x => x.id === fid);
            if(!f) return;
            event.stopPropagation();
            f.testV = f.testV === 'FA' ? '' : 'FA';
            render();
        }

        function toggleCheck(el, style, isRadio, fid, valName) {
            event.stopPropagation();
            const f = fields.find(x => x.id === fid);
            if(!f) return;

            let currentVals = f.testV ? f.testV.split(',') : [];
            
            if(isRadio) {
                // Fix 5: Radio can be toggled off if clicked again
                if (currentVals.includes(valName)) {
                    currentVals = []; // Deselect
                } else {
                    currentVals = [valName]; // Select new
                }
            } else {
                // Checkbox Logic (including Tri-state)
                if(style === 'mark-both') {
                    // Cycle: Empty -> V -> X -> Empty
                    if(currentVals.includes(valName)) {
                        // V -> X
                        currentVals = currentVals.filter(v => v !== valName);
                        currentVals.push(valName + "_NG");
                    } else if(currentVals.includes(valName + "_NG")) {
                        // X -> Empty
                        currentVals = currentVals.filter(v => v !== (valName + "_NG"));
                    } else {
                        // Empty -> V
                        currentVals.push(valName);
                    }
                } else if(style === 'mark-cross') {
                    // Toggle X only
                    if(currentVals.includes(valName + "_NG")) currentVals = currentVals.filter(v => v !== (valName+"_NG"));
                    else currentVals.push(valName + "_NG");
                } else {
                    // Normal Check (V) toggle
                    if(currentVals.includes(valName)) currentVals = currentVals.filter(v => v !== valName);
                    else currentVals.push(valName);
                }
            }
            f.testV = currentVals.join(',');
            render();
        }

        function validateInput(inp, id) {
            const f = fields.find(x => x.id === id);
            if(!f) return;
            const val = inp.value;
            const numVal = parseFloat(val);
            let hasError = false;
            
            if(f.req && !val.trim()) hasError = true;

            if(f.valRules && f.valRules.length > 0) {
                for(const r of f.valRules) {
                    if(r.target === 'len') {
                        const len = val.length;
                        if(r.op1 && !checkOp(len, r.op1, parseFloat(r.val1))) hasError = true;
                        if(r.op2 && !checkOp(len, r.op2, parseFloat(r.val2))) hasError = true;
                    } else if(r.target === 'val') {
                        if(isNaN(numVal)) { if(val!=='') hasError = true; }
                        else {
                            if(r.op1 && !checkOp(numVal, r.op1, parseFloat(r.val1))) hasError = true;
                            if(r.op2 && !checkOp(numVal, r.op2, parseFloat(r.val2))) hasError = true;
                        }
                    } else if(r.target === 'dec') {
                         if(val.includes('.')) {
                             const decPart = val.split('.')[1];
                             if(decPart.length > parseInt(r.val1)) hasError = true;
                         }
                    }
                }
            }

            if(hasError) {
                inp.classList.add('error-field');
                const card = document.querySelector(`.card[data-id="${id}"]`);
                if(card) {
                    const err = card.querySelector('.err-msg');
                    // Fix 2: Remove (NG Block) text, simple error indicator
                    if(err) { err.textContent = 'â— æ ¼å¼ä¸ç¬¦'; err.classList.add('show'); }
                    card.classList.add('error-state');
                }
            } else {
                inp.classList.remove('error-field');
                const card = document.querySelector(`.card[data-id="${id}"]`);
                if(card) {
                    const err = card.querySelector('.err-msg');
                    if(err) err.classList.remove('show');
                    card.classList.remove('error-state');
                }
            }

            // Unit Logic
            if(f.type === 'text' && f.uEnable) {
                const display = document.getElementById('unitDisplay_' + id);
                if(display) {
                    let newUnit = f.unitB;
                    if(!isNaN(numVal) && f.uRules && f.uRules.length > 0) {
                        for(const r of f.uRules) {
                            if(!r.cond || r.val === '' || !r.res) continue;
                            if(checkOp(numVal, r.cond, parseFloat(r.val))) {
                                newUnit = r.res;
                                break;
                            }
                        }
                    }
                    display.textContent = newUnit;
                }
            }
        }

        function checkOp(a, op, b) {
            if(op === '>') return a > b;
            if(op === '<') return a < b;
            if(op === '=') return a === b;
            if(op === '>=') return a >= b;
            if(op === '<=') return a <= b;
            return true;
        }

        function checkValidation() {
            let isValid = true;
            document.querySelectorAll('input[oninput]').forEach(i => {
                const fid = i.getAttribute('data-fid');
                validateInput(i, fid);
                if(i.classList.contains('error-field')) isValid = false;
            });
            if(!isValid) alert("âš ï¸ è¡¨å–®å«æœ‰éŒ¯èª¤ (æ ¼å¼ä¸ç¬¦) è³‡æ–™ï¼Œè«‹ä¿®æ­£å¾Œå†æäº¤ã€‚");
            return isValid;
        }

        /* --- Other Essential Functions --- */
        function highlightCard(id) {
             document.querySelectorAll('.card').forEach(c => {
                if(c.dataset.id === id) c.classList.add('selected');
                else c.classList.remove('selected');
            });
            if(id === 'form_meta') {
                document.getElementById('formMetaCard').classList.add('selected');
                document.querySelectorAll('.card').forEach(c => c.classList.remove('selected'));
            } else {
                document.getElementById('formMetaCard').classList.remove('selected');
            }
        }

        function select(id) {
            activeId = id;
            highlightCard(id);
            document.getElementById('noSel').style.display='none';
            if(id==='form_meta') {
                document.getElementById('editor').style.display='none';
                document.getElementById('formSettings').style.display='block';
                const mS = formConfig.metaStyle || { size: 28, color: '#000000', bgColor: 'transparent', bold: true };
                document.getElementById('mSize').value = mS.size;
                document.getElementById('metaPaletteContainer').innerHTML = getPaletteHTML('metaText', 'text', mS.color, 'indmetaText') + getPaletteHTML('metaBg', 'bg', mS.bgColor, 'indmetaBg');
                ['mB','mI','mU'].forEach(b => document.getElementById(b).classList.remove('active'));
                if(mS.bold) document.getElementById('mB').classList.add('active');
                if(mS.italic) document.getElementById('mI').classList.add('active');
                if(mS.underline) document.getElementById('mU').classList.add('active');
                document.getElementById('gLayout').value = formConfig.layout;
                document.getElementById('gTitleIdx').value = formConfig.titleIdx;
                document.getElementById('gDataIdx').value = formConfig.dataIdx;
                document.getElementById('gEnableTemp').checked = formConfig.enableTemp;
                document.getElementById('tempConfigBtn').style.display = formConfig.enableTemp ? 'block' : 'none';
                document.getElementById('gMetaDescE').checked = formConfig.metaDescE;
                return;
            }
            document.getElementById('formSettings').style.display='none';
            document.getElementById('editor').style.display='block';
            const f = fields.find(x => x.id === id);
            if(!f) return;
            sanitizeField(f);
            const setVal = (eid, val) => { if(document.getElementById(eid)) document.getElementById(eid).value = val; };
            const setChk = (eid, val) => { if(document.getElementById(eid)) document.getElementById(eid).checked = val; };

            setVal('pSize', f.size || 14);
            setVal('pWidth', f.width);
            setVal('pMode', f.mode);
            setVal('pUnitB', f.unitB);
            setVal('pLink', f.link);
            
            const canHaveDef = ['text','mixed-radio','mixed-checkbox'].includes(f.mode) || ['text','mixed-radio','mixed-checkbox'].includes(f.machineStyle);
            document.getElementById('pDefVal').style.display = canHaveDef ? 'block' : 'none';
            setVal('pDefVal', f.defVal);
            setVal('pOptLayout', f.optLayout); 
            
            setChk('pUpperCase', f.upper);
            setChk('pReq', f.req);
            setChk('pManual', f.manual);
            setChk('pDescE', f.descE);
            setChk('pUnitE', f.uEnable);
            if(document.getElementById('pMarkStyle')) document.getElementById('pMarkStyle').value = f.markStyle;
            if(document.getElementById('pMachineStyle')) document.getElementById('pMachineStyle').value = f.machineStyle;
            if(document.getElementById('pShiftStyle')) document.getElementById('pShiftStyle').value = f.shiftStyle;
            if(document.getElementById('pCorner')) setChk('pCorner', f.corner);
            if(document.getElementById('pShowCol')) setChk('pShowCol', f.showCol);
            if(document.getElementById('pShowRow')) setChk('pShowRow', f.showRow);

            if(document.getElementById('pShowTime')) setChk('pShowTime', f.showTime);
            if(document.getElementById('pAutoDate')) setChk('pAutoDate', f.autoDate);
            if(document.getElementById('pAutoTime')) setChk('pAutoTime', f.autoTime);
            if(document.getElementById('pDateOffset')) setChk('pDateOffset', f.dateOffset);
            
            if(document.getElementById('pShiftLogicE')) setChk('pShiftLogicE', f.shiftLogicE);
            if(document.getElementById('pAutoPrev')) setChk('pAutoPrev', f.autoPrev);
            if(f.type === 'text') {
                 const uLogic = document.getElementById('uLogic');
                 uLogic.style.display = f.uEnable ? 'block' : 'none';
                 if(f.uEnable) renderRules();
            }

            renderAutoPrevRules();
            renderValRules();
            document.getElementById('shiftSec').style.display = f.type==='shift'?'block':'none';
            
            const isMachine = f.type === 'machine';
            document.getElementById('machineSec').style.display = isMachine ? 'block' : 'none';
            if(isMachine) renderMachineRules();
            
            const showMarkStyle = ['choices','grid'].includes(f.type) || (isMachine && ['radio','checkbox','mixed-radio','mixed-checkbox'].includes(f.machineStyle));
            const msDiv = document.getElementById('markStyleSec');
            if(msDiv) msDiv.style.display = showMarkStyle ? 'block' : 'none';

            document.getElementById('dateSec').style.display = f.type==='datetime'?'block':'none';
            
            let isLinked = false;
            fields.forEach(ff => {
                if(ff.machineRules) ff.machineRules.forEach(r => {
                    if(r.target && r.target.split(',').includes(f.id)) isLinked = true;
                });
            });
            const canHaveOpts = ['dropdown','shift','machine','choices'].includes(f.type);
            document.getElementById('optSec').style.display = (canHaveOpts && !isLinked) ? 'block' : 'none';
            document.getElementById('optSecLocked').style.display = (canHaveOpts && isLinked) ? 'block' : 'none';
            const isDropdown = f.type === 'dropdown' || f.machineStyle === 'dropdown';
            document.getElementById('optLayoutRow').style.display = isDropdown ? 'none' : 'flex';

            if(canHaveOpts && !isLinked) renderSidebarOpts();
            
            /* Fix: Show Validation Rules for Mixed types too */
            const showValidation = ['text', 'batch'].includes(f.type) || (f.mode && f.mode.includes('mixed'));
            document.getElementById('contentSec').style.display = showValidation ? 'block' : 'none';

            document.getElementById('modeSec').style.display = ['choices'].includes(f.type)?'block':'none';
            if(f.type === 'choices') {
                const modeSel = document.getElementById('pMode');
                Array.from(modeSel.options).forEach(opt => {
                    if(opt.value === 'text') opt.style.display = 'none';
                });
            } else {
                const modeSel = document.getElementById('pMode');
                Array.from(modeSel.options).forEach(opt => { opt.style.display = 'block'; });
            }
            
            document.getElementById('customRowSec').style.display = f.type === 'custom_row' ? 'block' : 'none';
            if(f.type === 'custom_row') renderCustomElems();
        }

        function getIconForMode(m) {
            if(m==='text') return 'ğŸ“';
            if(m==='radio') return 'ğŸ”˜'; if(m==='checkbox') return 'â˜‘ï¸';
            if(m==='mixed-radio') return 'ğŸ”˜ğŸ“'; if(m==='mixed-checkbox') return 'â˜‘ï¸ğŸ“'; return 'ğŸ“';
        }
        
        function toggleGridColMode(id, idx, btn) {
            const f = fields.find(x => x.id === id);
            const modes = ['text', 'radio', 'checkbox', 'mixed-radio', 'mixed-checkbox'];
            let current = (f.cellModes && f.cellModes[0]) ? f.cellModes[0][idx] : 'text';
            let next = modes[(modes.indexOf(current) + 1) % modes.length];
            f.cellModes.forEach(row => { row[idx] = next; });
            if(btn) btn.innerHTML = getIconForMode(next); 
            render();
        }
        function cycleGridColMode(id, idx) { toggleGridColMode(id, idx, null); }
        function cycleGridRowMode(id, rIdx) {
            const f = fields.find(x => x.id === id);
            const modes = ['text', 'radio', 'checkbox', 'mixed-radio', 'mixed-checkbox'];
            let current = (f.cellModes && f.cellModes[rIdx]) ? f.cellModes[rIdx][0] : 'text';
            let next = modes[(modes.indexOf(current) + 1) % modes.length];
            f.cellModes[rIdx] = new Array(f.cols.length).fill(next);
            render();
        }

        function applyGlobal() {
            formConfig.layout = document.getElementById('gLayout').value;
            formConfig.titleIdx = document.getElementById('gTitleIdx').value;
            formConfig.dataIdx = document.getElementById('gDataIdx').value;
            formConfig.enableTemp = document.getElementById('gEnableTemp').checked;
            formConfig.metaDescE = document.getElementById('gMetaDescE').checked;
            if(!formConfig.metaStyle) formConfig.metaStyle = {};
            formConfig.metaStyle.size = document.getElementById('mSize').value;
            document.getElementById('tempConfigBtn').style.display = formConfig.enableTemp ? 'block' : 'none';
            render();
        }

        function apply() {
            if(!activeId) return;
            const f = fields.find(x => x.id === activeId);
            if(!f) return;
            f.size = document.getElementById('pSize').value;
            f.width = document.getElementById('pWidth').value;
            f.mode = document.getElementById('pMode').value;
            f.unitB = document.getElementById('pUnitB').value;
            f.link = document.getElementById('pLink').value;
            f.defVal = document.getElementById('pDefVal').value;
            f.optLayout = document.getElementById('pOptLayout') ? document.getElementById('pOptLayout').value : 'vertical'; 
            f.upper = document.getElementById('pUpperCase').checked;
            f.req = document.getElementById('pReq').checked;
            f.manual = document.getElementById('pManual').checked;
            f.descE = document.getElementById('pDescE').checked;
            f.uEnable = document.getElementById('pUnitE').checked;
            if(document.getElementById('pMarkStyle')) f.markStyle = document.getElementById('pMarkStyle').value;
            if(document.getElementById('pMachineStyle')) f.machineStyle = document.getElementById('pMachineStyle').value;
            if(document.getElementById('pShiftStyle')) f.shiftStyle = document.getElementById('pShiftStyle').value;
            if(document.getElementById('pCorner')) f.corner = document.getElementById('pCorner').checked;
            if(document.getElementById('pShowCol')) f.showCol = document.getElementById('pShowCol').checked;
            if(document.getElementById('pShowRow')) f.showRow = document.getElementById('pShowRow').checked;
            if(document.getElementById('pShowTime')) f.showTime = document.getElementById('pShowTime').checked;
            if(document.getElementById('pAutoDate')) f.autoDate = document.getElementById('pAutoDate').checked;
            if(document.getElementById('pAutoTime')) f.autoTime = document.getElementById('pAutoTime').checked;
            if(document.getElementById('pDateOffset')) f.dateOffset = document.getElementById('pDateOffset').checked;
            if(document.getElementById('pShiftLogicE')) f.shiftLogicE = document.getElementById('pShiftLogicE').checked;
            if(document.getElementById('pAutoPrev')) f.autoPrev = document.getElementById('pAutoPrev').checked;
            if(f.type === 'text') {
                 const uLogic = document.getElementById('uLogic');
                 if(f.uEnable) { uLogic.style.display = 'block'; renderRules(); } else { uLogic.style.display = 'none'; }
            }
            select(activeId);
            render();
        }

        /* --- Custom Element Builder --- */
        function renderCustomElems() {
            const f = fields.find(x=>x.id===activeId);
            document.getElementById('customElemList').innerHTML = (f.customElems||[]).map((el,i) => `
                <div class="opt-manage-item">
                    <span style="font-size:11px; font-weight:bold; color:#555;">${el.type}</span>
                    <input style="width:60px;" placeholder="Label/Ph" value="${el.label||el.placeholder||''}" oninput="f.customElems[${i}].${el.type==='input'?'placeholder':'label'}=this.value; render()">
                    ${el.type==='input' ? `<input type="number" style="width:40px;" placeholder="å¯¬(px)" title="è¼¸å…¥æ¡†å¯¬åº¦(px)" value="${el.width||80}" oninput="f.customElems[${i}].width=this.value; render()">` : ''}
                    <span onclick="f.customElems.splice(${i},1); renderCustomElems(); render()">Ã—</span>
                </div>
            `).join('');
        }
        function addCustomElem(type) {
            const f = fields.find(x=>x.id===activeId);
            f.customElems.push({type, label:type==='text'?'æ¨™ç±¤':'', placeholder:type==='input'?'è¼¸å…¥':''});
            renderCustomElems(); render();
        }

        /* --- Validation Rules (Fix 2: Cleaner UI) --- */
        function addValRule() { 
            if(!activeId) return;
            const f = fields.find(x=>x.id===activeId);
            if(f) {
                if(!f.valRules) f.valRules = [];
                f.valRules.push({target: 'val', op1: '', val1: '0', op2: '', val2: '100'});
                renderValRules(); 
                apply();
            }
        }
        function delValRule(i) { if(!activeId) return; fields.find(x=>x.id===activeId).valRules.splice(i, 1); renderValRules(); apply(); }
        function upValRule(i, k, v) { 
            if(!activeId) return;
            const f = fields.find(x=>x.id===activeId);
            if(k === 'target') {
                if(v === 'dec') f.valRules[i] = { target: 'dec', val1: '2', op1: 'round' };
                else if(v === 'len') f.valRules[i] = { target: 'len', op1: '', val1: '0', op2: '', val2: '50' };
                else f.valRules[i] = { target: 'val', op1: '', val1: '0', op2: '', val2: '100' };
                renderValRules();
            } else {
                f.valRules[i][k] = v;
                apply();
            }
        }
        function renderValRules() {
            if(!activeId) return;
            const f = fields.find(x=>x.id===activeId);
            if(f) {
                document.getElementById('valRulesList').innerHTML = (f.valRules||[]).map((r,i) => {
                    if(r.target === 'dec') {
                        return `<div class="val-rule-item"><select class="val-type-sel" onchange="upValRule(${i},'target',this.value)"><option value="len" ${r.target==='len'?'selected':''}>å­—æ•¸</option><option value="val" ${r.target==='val'?'selected':''}>æ•¸å€¼</option><option value="dec" ${r.target==='dec'?'selected':''}>å°æ•¸</option></select><input type="number" style="width:40px;" value="${r.val1}" placeholder="ä½" oninput="upValRule(${i},'val1',this.value)"><select style="flex:1;" onchange="upValRule(${i},'op1',this.value)"><option value="round" ${r.op1==='round'?'selected':''}>å››æ¨äº”å…¥</option><option value="ceil" ${r.op1==='ceil'?'selected':''}>ç„¡æ¢ä»¶é€²ä½</option><option value="floor" ${r.op1==='floor'?'selected':''}>ç„¡æ¢ä»¶æ¨å»</option></select><span class="val-del" onclick="delValRule(${i})">Ã—</span></div>`;
                    }
                    return `<div class="val-rule-item">
                        <select class="val-type-sel" onchange="upValRule(${i},'target',this.value)"><option value="len" ${r.target==='len'?'selected':''}>å­—æ•¸</option><option value="val" ${r.target==='val'?'selected':''}>æ•¸å€¼</option><option value="dec" ${r.target==='dec'?'selected':''}>å°æ•¸</option></select>
                        <select class="val-op-sel" onchange="upValRule(${i},'op1',this.value)"><option value="" ${r.op1===''?'selected':''}>&gt;</option><option value="<" ${r.op1==='<'?'selected':''}>&lt;</option><option value="=" ${r.op1==='='?'selected':''}>=</option><option value=">=" ${r.op1==='>='?'selected':''}>â‰¥</option><option value="<=" ${r.op1==='<='?'selected':''}>â‰¤</option></select>
                        <input type="number" class="val-inp" value="${r.val1}" placeholder="A" oninput="upValRule(${i},'val1',this.value)">
                        <span style="font-weight:bold; color:#666;">ä¸”</span>
                        <select class="val-op-sel" onchange="upValRule(${i},'op2',this.value)"><option value="" ${r.op2===''?'selected':''}>&gt;</option><option value="<" ${r.op2==='<'?'selected':''}>&lt;</option><option value="=" ${r.op2==='='?'selected':''}>=</option><option value=">=" ${r.op2==='>='?'selected':''}>â‰¥</option><option value="<=" ${r.op2==='<='?'selected':''}>â‰¤</option></select>
                        <input type="number" class="val-inp" value="${r.val2}" placeholder="B" oninput="upValRule(${i},'val2',this.value)">
                        <span class="val-del" onclick="delValRule(${i})">Ã—</span>
                    </div>`;}).join('');
            }
        }

        /* --- Other Helper Functions --- */
        function toggleMetaStyle(s) {
            if(!formConfig.metaStyle) formConfig.metaStyle = {};
            formConfig.metaStyle[s] = !formConfig.metaStyle[s]; applyGlobal();
            if(s==='bold') document.getElementById('mB').classList.toggle('active');
            if(s==='italic') document.getElementById('mI').classList.toggle('active');
            if(s==='underline') document.getElementById('mU').classList.toggle('active');
        }
        function toggleStyle(s) {
            const f = fields.find(x => x.id === activeId);
            if(f) {
                f[s] = !f[s];
                const btnMap = { bold: 'bB', italic: 'bI', underline: 'bU' };
                document.getElementById(btnMap[s]).classList.toggle('active');
                render();
            }
        }
        function renderSidebarOpts() {
            const f = fields.find(x=>x.id===activeId);
            document.getElementById('optList').innerHTML = (f.opts||[]).map((o,i) => `<div class="opt-manage-item"><span class="opt-drag-handle">â˜°</span><input value="${o}" oninput="upOpt(${i},this.value)"> <span onclick="delOpt(${i})">Ã—</span></div>`).join('');
            initOptionSortable();
        }
        function initOptionSortable() {
            const el = document.getElementById('optList');
            if(el) { new Sortable(el, { animation: 150, handle: '.opt-drag-handle', onEnd: function(evt) { const f = fields.find(x=>x.id===activeId); if(f) { const movedItem = f.opts.splice(evt.oldIndex, 1)[0]; f.opts.splice(evt.newIndex, 0, movedItem); render(); } } }); }
        }
        window.upOpt = (i,v) => { const f = fields.find(x=>x.id===activeId); f.opts[i]=v; render(); if(f.type === 'machine') renderMachineRules(); };
        window.delOpt = (i) => { const f=fields.find(x=>x.id===activeId); f.opts.splice(i,1); renderSidebarOpts(); render(); if(f.type === 'machine') renderMachineRules(); };
        function autoResize(textarea) { textarea.style.height = 'auto'; textarea.style.height = textarea.scrollHeight + 'px'; }
        function syncMeta() { /* Handled via getElementById on export */ }
        function syncTitle(id, val) { fields.find(x=>x.id===id).title = val; }
        function syncDesc(id, val) { fields.find(x=>x.id===id).desc = val; }
        function syncGridCol(id, idx, val) { fields.find(x=>x.id===id).cols[idx] = val; }
        function syncGridRow(id, idx, val) { fields.find(x=>x.id===id).rows[idx] = val; }
        function addCol(id) { const f=fields.find(x=>x.id===id); f.cols.push(`ç¬¬ ${f.cols.length+1} æ¬„`); f.cellModes.forEach(row => row.push('text')); render(); select(id); }
        function delCol(id, i) { const f=fields.find(x=>x.id===id); if(f.cols.length>1){ f.cols.splice(i,1); f.cellModes.forEach(row => row.splice(i,1)); render(); select(id); } }
        function addRow(id) { const f=fields.find(x=>x.id===id); f.rows.push(`ç¬¬ ${f.rows.length+1} åˆ—`); f.cellModes.push(new Array(f.cols.length).fill('text')); render(); select(id); }
        function delRow(id, i) { const f=fields.find(x=>x.id===id); if(f.rows.length>1){ f.rows.splice(i,1); f.cellModes.splice(i,1); render(); select(id); } }
        function addSidebarOpt() { const f=fields.find(x=>x.id===activeId); if(f) { f.opts.push(`é¸é … ${f.opts.length+1}`); renderSidebarOpts(); render(); if(f.type === 'machine') renderMachineRules(); } }
        function bulkAddSidebarOpt() { const f = fields.find(x=>x.id===activeId); if(f) { const text = prompt("è«‹è¼¸å…¥é¸é … (æ¯è¡Œä¸€å€‹):"); if(text) { const lines = text.split('\n').map(l => l.trim()).filter(l => l); f.opts = [...f.opts, ...lines]; renderSidebarOpts(); render(); if(f.type === 'machine') renderMachineRules(); } } }
        function runMachineLogic(id, val) { const f = fields.find(x => x.id === id); if (!f || !f.machineRules) return; f.testV = val; const rule = f.machineRules.find(r => r.val.split(',').includes(val)); if (rule) { const targetIds = rule.target.split(','); targetIds.forEach(tid => { let tf = fields.find(x => x.id === tid.trim()); if(!tf) tf = fields.find(x => x.title === tid.trim()); if (tf) { const newOpts = rule.targetOpts.split(',').map(s=>s.trim()).filter(s=>s); if(tf.type === 'grid') { tf.cols = newOpts; while(tf.colModes.length < tf.cols.length) tf.colModes.push('text'); if(tf.colModes.length > tf.cols.length) tf.colModes = tf.colModes.slice(0, tf.cols.length); } else { tf.opts = newOpts; } } }); render(); setTimeout(() => select(id), 50); } else { render(); } }
        function addMachineRule() { if(!activeId) return; const f = fields.find(x=>x.id===activeId); if(f) { if(!f.machineRules) f.machineRules = []; f.machineRules.push({val:'', target:'', targetOpts:'1è»¸,2è»¸'}); renderMachineRules(); render(); } }
        function renderMachineRules() { if(!activeId) return; const f = fields.find(x=>x.id===activeId); if(f) { const allFieldOpts = fields.map(ff => ({id:ff.id, title:`${ff.title} (${ff.type})`})); document.getElementById('mRules').innerHTML = (f.machineRules||[]).map((r,i) => { const msIdVal = `msMachVal${i}`; const msIdTarget = `msMachTarget${i}`; const machOpts = (f.opts || []).map(o => ({id:o, title:o})); const selectedVals = r.val ? r.val.split(',') : []; const selectedTargets = []; if(r.target) { const targetIds = r.target.split(','); targetIds.forEach(tId => { if(fields.some(ff => ff.id === tId)) selectedTargets.push(tId); }); } setTimeout(() => { renderMultiSelectHTML(msIdVal, machOpts, selectedVals, `mach_val${i}`); renderMultiSelectHTML(msIdTarget, allFieldOpts, selectedTargets, `mach_target${i}`); }, 0); return `<div style="background:#fff; border:1px solid #ddd; padding:6px; border-radius:4px; margin-bottom:5px;"><div style="display:flex; align-items:center; gap:4px; margin-bottom:4px;"><span style="font-size:11px; color:#666; width:50px;">ç•¶æ©Ÿå°=</span><div id="${msIdVal}" class="ms-container" style="flex:1;"></div><span style="cursor:pointer; margin-left:4px; color:#999;" onclick="delM(${i})">âœ•</span></div><div style="display:flex; flex-direction:column; gap:4px;"><label style="font-size:11px; color:#666;">é€£å‹•ç›®æ¨™æ¬„ä½</label><div id="${msIdTarget}" class="ms-container"></div><input style="width:100%; border:1px solid #ccc; padding:3px; font-size:12px; margin-top:4px;" placeholder="æ–°é¸é …/åˆ—åé è¨­å€¼ (é€—è™Ÿéš”é–‹)" value="${r.targetOpts}" oninput="upM(${i},'targetOpts',this.value)"></div></div>`; }).join(''); } }
        window.upM = (i,k,v) => { if(!activeId) return; fields.find(x=>x.id===activeId).machineRules[i][k]=v; };
        window.delM = (i) => { if(!activeId) return; fields.find(x=>x.id===activeId).machineRules.splice(i,1); renderMachineRules(); };
        function addShiftRule() { fields.find(x=>x.id===activeId).shiftRules.push({start:'08:00', end:'12:00', val:'æ—©ç­'}); renderShiftRules(); render(); }
        function renderShiftRules() { const f = fields.find(x=>x.id===activeId); document.getElementById('sRules').innerHTML = (f.shiftRules||[]).map((r,i) => `<div class="logic-line"><input type="time" class="time-inp-fix" value="${r.start}" oninput="upS(${i},'start',this.value)"> ~ <input type="time" class="time-inp-fix" value="${r.end}" oninput="upS(${i},'end',this.value)"> <input class="logic-val-input" placeholder="ç­åˆ¥" value="${r.val}" oninput="upS(${i},'val',this.value)"> <span class="logic-del-btn" onclick="delS(${i})">âœ•</span></div>`).join(''); }
        window.upS = (i,k,v) => { fields.find(x=>x.id===activeId).shiftRules[i][k]=v; render(); };
        window.delS = (i) => { fields.find(x=>x.id===activeId).shiftRules.splice(i,1); renderShiftRules(); render(); };
        function addURule() { fields.find(x=>x.id===activeId).uRules.push({cond:'', val:'', res:''}); renderRules(); }
        function renderRules() { const f = fields.find(x=>x.id===activeId); document.getElementById('uRules').innerHTML = (f.uRules||[]).map((r,i)=>`<div class="logic-line">ç•¶ <select onchange="upR(${i},'cond',this.value)"><option value="" ${r.cond===''?'selected':''}></option><option value=">" ${r.cond==='>'?'selected':''}>&gt;</option><option value="<" ${r.cond==='<'?'selected':''}>&lt;</option><option value="=" ${r.cond==='='?'selected':''}>=</option><option value=">=" ${r.cond==='>='?'selected':''}>â‰¥</option><option value="<=" ${r.cond==='<='?'selected':''}>â‰¤</option></select> <input style="width:40px; flex:1;" value="${r.val}" oninput="upR(${i},'val',this.value)"> å¸¶å…¥ <input style="width:40px; flex:1;" value="${r.res}" oninput="upR(${i},'res',this.value)"> <span class="logic-del-btn" onclick="delR(${i})">ğŸ—‘</span></div>`).join(''); }
        window.upR = (i,k,v) => { if(!activeId) return; fields.find(x=>x.id===activeId).uRules[i][k]=v; };
        window.delR = (i) => { fields.find(x=>x.id===activeId).uRules.splice(i, 1); renderRules(); };
        function copyF(id) { const f=fields.find(x=>x.id===id); const n=JSON.parse(JSON.stringify(f)); n.id='f'+Date.now(); fields.splice(fields.findIndex(x=>x.id===id)+1,0,n); render(); select(n.id); }
        function delF(id) { fields=fields.filter(x=>x.id!==id); activeId=null; render(); document.getElementById('editor').style.display='none'; document.getElementById('noSel').style.display='block'; }
        
        function hExport() { 
            // Fix 3: Batch Export Logic (FA/Main/Sub)
            const clean = fields.map(f => { 
                let exportVal = f.testV;
                if(f.type === 'batch') {
                    // Logic: If testV contains "FA", prepend FA. Combine inputs (simulated by defVal for now since we don't store inputs in schema)
                    // Note: In real app, inputs are runtime data. Here we export SCHEMA.
                    // If user wants to test export structure:
                    // This function exports SCHEMA structure, but let's store logic hints.
                }
                const { testV, ...cF } = f; 
                return cF; 
            });
            const d = { title:document.getElementById('mT').value, desc:document.getElementById('mD').value, config: formConfig, fields:clean }; 
            const blob = new Blob([JSON.stringify(d, null, 2)], {type:'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'questions.json'; a.click();
        }
        function hImport(inp) { const r=new FileReader(); r.onload=(e)=>{ const d=JSON.parse(e.target.result); document.getElementById('mT').value=d.title; document.getElementById('mD').value=d.desc; if(d.config) formConfig = d.config; fields=d.fields.map(f=>({...f, valRules: f.valRules || [], autoPrevRules: f.autoPrevRules || [], machineRules: f.machineRules || [], shiftRules: f.shiftRules || [], uRules: f.uRules || [], opts: f.opts || [], colModes: f.colModes || [] })); render(); }; r.readAsText(inp.files[0]); }
        function addAutoPrevRule() { if(!activeId) return; const f = fields.find(x=>x.id===activeId); if(f) { if(!f.autoPrevRules) f.autoPrevRules = []; f.autoPrevRules.push({start:'08:00', end:'12:00'}); renderAutoPrevRules(); render(); } }
        function renderAutoPrevRules() { if(!activeId) return; const f = fields.find(x=>x.id===activeId); if(f) { document.getElementById('apRules').innerHTML = (f.autoPrevRules||[]).map((r,i) => `<div class="logic-line"><input type="time" class="time-inp-fix" value="${r.start}" oninput="upAP(${i},'start',this.value)"> ~ <input type="time" class="time-inp-fix" value="${r.end}" oninput="upAP(${i},'end',this.value)"> <span class="logic-del-btn" onclick="delAP(${i})">ğŸ—‘</span></div>`).join(''); } }
        window.upAP = (i,k,v) => { if(!activeId) return; fields.find(x=>x.id===activeId).autoPrevRules[i][k]=v; render(); };
        window.delAP = (i) => { if(!activeId) return; fields.find(x=>x.id===activeId).autoPrevRules.splice(i,1); renderAutoPrevRules(); render(); };
        function updateModalCalc(i, key, val) { tempModalState.calcCols[i][key] = val; renderModalCalcs(); }
        function addTempCalc() { tempModalState.calcCols.push({ id: 'c'+Date.now(), title: 'æ–°çµ±è¨ˆ', type: 'sum_fields', targets: [], ruleVal: '', ruleOp: '', ruleColor: '#d93025' }); renderModalCalcs(); }
        function delModalCalc(i) { tempModalState.calcCols.splice(i, 1); renderModalCalcs(); }
        function addClearTime() { tempModalState.clearTimes.push('12:00'); renderModalTimes(); }
        function delClearTime(i) { tempModalState.clearTimes.splice(i, 1); renderModalTimes(); }
        function updateClearTime(i, v) { tempModalState.clearTimes[i] = v; }
        function togglePreviewMode() {
            document.body.classList.toggle('preview-mode');
            activeId = null; 
            render();
            document.getElementById('formSettings').style.display = 'none';
            document.getElementById('editor').style.display = 'none';
            document.getElementById('noSel').style.display = 'none';
        }
    </script>
</body>
</html>
