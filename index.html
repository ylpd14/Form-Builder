<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ˆæ¥­è¡¨å–®è¦æ ¼ç”Ÿæˆå™¨ v62.28 (Final Full Integration)</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        /* --- æ ¸å¿ƒè®Šæ•¸è¨­å®š --- */
        :root { 
            --p: #1a73e8; 
            --bg: #f8f9fa; 
            --border: #dadce0; 
            --radius: 4px; 
            --danger: #d93025; 
            --highlight: #fef08a; 
            --temp-btn: #fbc02d; 
            --submit-btn: #34a853;
        }

        * { 
            box-sizing: border-box; 
        }

        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            margin: 0; 
            padding: 5px; 
            display: flex; 
            height: 100vh; 
            overflow: hidden; 
            background: var(--bg); 
            color: #202124; 
            gap: 8px; 
        }
        
        /* --- ä½ˆå±€æ¨£å¼ (Layout) --- */
        .sidebar-l { 
            width: 240px; 
            background: #fff; 
            border: 1px solid var(--border); 
            display: flex; 
            flex-direction: column; 
            flex-shrink: 0; 
            border-radius: 4px; 
            transition: transform 0.3s; 
        }

        .sidebar-r { 
            width: 360px; 
            background: #fff; 
            border: 1px solid var(--border); 
            padding: 10px; 
            overflow-y: auto; 
            flex-shrink: 0; 
            border-radius: 4px; 
            transition: transform 0.3s; 
        }

        .scroll-area { 
            flex: 1; 
            overflow-y: auto; 
            padding: 10px; 
        }

        .canvas-area { 
            flex: 1; 
            padding: 10px 20px; 
            overflow-y: auto; 
            background: #eef1f4; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            border: 1px solid var(--border); 
            border-radius: 4px; 
            position: relative; 
        }

        .canvas-container { 
            width: 100%; 
            max-width: 900px; 
            padding-bottom: 100px; 
            transition: 0.3s; 
        }

        /* --- é è¦½æ¨¡å¼ (Preview Mode) --- */
        .preview-bar { 
            display: none; 
            width: 100%; 
            background: #333; 
            color: #fff; 
            padding: 10px; 
            text-align: center; 
            position: absolute; 
            top: 0; 
            left: 0; 
            z-index: 9999; 
            justify-content: center; 
            gap: 20px; 
            align-items: center; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        body.preview-mode .preview-bar { display: flex; }
        
        /* é è¦½æ™‚éš±è—å…©å´æ¬„ä½ */
        body.preview-mode .sidebar-l, 
        body.preview-mode .sidebar-r { 
            display: none !important; 
        }

        body.preview-mode .canvas-area { 
            max-width: 100%; 
            padding: 40px 20px; 
        }

        /* é è¦½æ™‚å¡ç‰‡æ¨£å¼é‚„åŸ */
        body.preview-mode .card { 
            border: 1px solid transparent; 
            box-shadow: none; 
            background: #fff; 
            margin-bottom: 15px; 
            padding: 15px; 
            border-bottom: 1px solid #eee; 
        }
        body.preview-mode .card:last-child { border-bottom: none; }
        body.preview-mode .card.selected { 
            border: 1px solid transparent !important; 
            box-shadow: none !important; 
        }
        
        /* é è¦½æ™‚ï¼šè§£é–è¼¸å…¥æ¡† (é—œéµä¿®å¾©) */
        body.preview-mode .no-drag { pointer-events: auto !important; cursor: text; }
        body.preview-mode .fake-icon { cursor: pointer !important; pointer-events: auto !important; }
        body.preview-mode select { pointer-events: auto !important; }
        body.preview-mode input { pointer-events: auto !important; }
        body.preview-mode textarea { pointer-events: auto !important; }
        body.preview-mode .title-inp { border-bottom: none !important; background: transparent !important; color: #000; pointer-events: none !important; }
        
        /* é è¦½æ™‚ï¼šéš±è—ç·¨è¼¯å·¥å…· */
        body.preview-mode .card-tools, 
        body.preview-mode .grid-add-btn, 
        body.preview-mode .del-col-btn, 
        body.preview-mode .del-row-btn,
        body.preview-mode .opt-manage-item span,
        body.preview-mode .desc-inp { 
            display: none !important; 
        }

        /* --- Typography & Buttons --- */
        h3 { 
            border-bottom: 2px solid #333; 
            margin: 0 0 8px 0; 
            padding-bottom: 5px; 
            font-size: 0.95rem; 
            font-weight: bold; 
        }

        .cat { 
            font-size: 11px; 
            font-weight: bold; 
            color: #70757a; 
            margin: 10px 0 4px 0; 
            text-transform: uppercase; 
            border-left: 3px solid var(--p); 
            padding-left: 5px; 
        }

        .btn-t { 
            width: 100%; 
            padding: 8px; 
            margin-bottom: 4px; 
            background: #fff; 
            border: 1px solid var(--border); 
            border-radius: 4px; 
            cursor: pointer; 
            text-align: left; 
            font-size: 13px; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            transition: 0.2s; 
        }
        .btn-t:hover { 
            background: #f8f9fa; 
            border-color: var(--p); 
            color: var(--p); 
        }

        .btn-main { 
            width: 100%; 
            padding: 12px; 
            border: none; 
            border-radius: 8px; 
            font-weight: bold; 
            cursor: pointer; 
            font-size: 13px; 
            transition: 0.2s; 
        }
        .btn-main:active { transform: scale(0.98); }
        .btn-blue { background: var(--p); color: #fff; }

        /* --- Cards --- */
        .meta-card { 
            background: #fff; 
            border: 1px solid var(--border); 
            border-radius: var(--radius); 
            padding: 15px; 
            border-top: 8px solid #333; 
            margin-bottom: 10px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
            cursor: pointer; 
            transition: 0.2s; 
        }
        .meta-card.selected { 
            border: 2px solid var(--p); 
            box-shadow: 0 0 8px rgba(26, 115, 232, 0.2); 
        }

        .sortable-list { 
            display: grid; 
            grid-template-columns: repeat(12, 1fr); 
            gap: 10px; 
            min-height: 100px; 
            width: 100%; 
        }

        .card { 
            grid-column: span 12; 
            background: #fff; 
            border: 1px solid var(--border); 
            border-radius: var(--radius); 
            padding: 15px; 
            position: relative; 
            cursor: default; 
            transition: 0.2s; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); 
        }
        .card.selected { 
            border: 2px solid var(--p) !important; 
            box-shadow: 0 0 8px rgba(26, 115, 232, 0.3); 
            z-index: 10; 
        }
        .card.error-state { 
            border: 2px solid var(--danger) !important; 
            background: #fff5f5; 
        }

        .w-100 { grid-column: span 12; } 
        .w-50 { grid-column: span 6; } 
        .w-33 { grid-column: span 4; }
        
        /* --- Inputs --- */
        .title-inp { 
            width: 100%; 
            border: none; 
            border-bottom: 1px solid transparent; 
            outline: none; 
            background: transparent; 
            transition: 0.2s; 
            padding: 2px; 
            font-weight: bold; 
            min-width: 0; 
            resize: none; 
            overflow: hidden; 
            font-family: inherit; 
            display: block; 
            height: auto; 
            position: relative; 
            z-index: 2; 
        }
        .title-inp:hover { border-bottom: 1px dashed #ccc; }
        .title-inp:focus { border-bottom: 2px solid var(--p); background: #fefefe; }

        .desc-inp { 
            width: 100%; 
            border: none; 
            border-bottom: 1px solid #eee; 
            padding: 4px 2px; 
            font-size: 13px; 
            outline: none; 
            background: transparent; 
            resize: none; 
            overflow: hidden; 
            font-family: inherit; 
            color: #666; 
            position: relative; 
            z-index: 2; 
        }
        .desc-inp:focus { border-bottom: 1px solid var(--p); color: #333; background: #fff; }
        
        .style-v27-box { 
            width: 100%; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            padding: 4px 6px; 
            font-size: 12px; 
            height: 28px; 
            outline: none; 
            transition: 0.2s; 
            background: #fff; 
            position: relative; 
            z-index: 2; 
        }
        .style-v27-box:focus { 
            border-color: var(--p); 
            box-shadow: 0 0 0 2px rgba(26,115,232,0.1); 
        }
        .style-v27-box.error-border { 
            border-color: var(--danger) !important; 
            background-color: #fff0f0 !important; 
            box-shadow: 0 0 0 1px var(--danger);
        }
        
        .err-msg { 
            font-size: 11px; 
            color: var(--danger); 
            font-weight: bold; 
            margin-top: 4px; 
            display: none; 
        }
        .err-msg.show { display: block; }

        /* --- Batch & Custom Row --- */
        .batch-container { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            padding: 8px 12px; 
            border: 1px solid #e0e0e0; 
            border-radius: 6px; 
            background: #fff; 
            width: 100%; 
            margin-top: 5px; 
            flex-wrap: wrap;
        }
        .batch-label { 
            display: flex; 
            align-items: center; 
            gap: 4px; 
            font-weight: bold; 
            font-size: 13px; 
            margin-right: 8px; 
            white-space: nowrap; 
            cursor: pointer;
        }
        .batch-input-flex { 
            flex: 1; 
            min-width: 0; 
            text-align: center; 
            width: 100%; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            padding: 4px; 
            outline: none; 
            position: relative; 
            z-index: 2; 
        }
        .remark-box { 
            width: 100%; 
            border: 1px solid #ccc; 
            border-radius: 6px; 
            padding: 8px; 
            font-size: 13px; 
            resize: vertical; 
            outline: none; 
            transition: 0.2s; 
            background: #fff; 
            min-height: 60px; 
            position: relative; 
            z-index: 2; 
        }
        .remark-box:focus { border-color: var(--p); box-shadow: 0 0 0 2px rgba(26,115,232,0.1); }
        
        /* --- Grid System --- */
        .grid-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 5px; 
            table-layout: fixed; 
        }
        .grid-table th, .grid-table td { 
            border: 1px solid #ddd; 
            padding: 4px; 
            text-align: center; 
            vertical-align: middle; 
            position: relative; 
            font-size: 13px; 
        }
        .grid-inp { 
            border: none; 
            text-align: center; 
            width: 100%; 
            outline: none; 
            font-weight: bold; 
            background: transparent; 
            font-size: 12px; 
            position: relative; 
            z-index: 2; 
        }
        .grid-cell-wrapper { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            width: 100%; 
            height: 100%; 
            gap: 6px; 
        }
        .slash-header { 
            position: relative; 
            background-color: #fff; 
            height: 45px; 
            background-image: linear-gradient(to bottom right, transparent calc(50% - 0.5px), #ddd calc(50% - 0.5px), #ddd calc(50% + 0.5px), transparent calc(50% + 0.5px)); 
        }
        .slash-top { 
            position: absolute; 
            top: 2px; 
            right: 4px; 
            width: 45%; 
            border: none; 
            background: transparent; 
            text-align: right; 
            font-size: 11px; 
            outline: none; 
            color: #666; 
            font-weight: bold; 
            z-index: 2; 
        }
        .slash-bot { 
            position: absolute; 
            bottom: 2px; 
            left: 4px; 
            width: 45%; 
            border: none; 
            background: transparent; 
            text-align: left; 
            font-size: 11px; 
            outline: none; 
            color: #666; 
            font-weight: bold; 
            z-index: 2; 
        }
        
        .del-col-btn { 
            position: absolute; 
            top: -10px; 
            right: -5px; 
            color: var(--danger); 
            cursor: pointer; 
            font-size: 14px; 
            background: #fff; 
            border-radius: 50%; 
            padding: 0 4px; 
            display: none; 
            border: 1px solid #eee; 
            z-index: 5; 
        }
        .grid-table th:hover .del-col-btn { display: block; }
        
        .del-row-btn { 
            font-size: 16px; 
            color: #bbb; 
            cursor: pointer; 
            margin-left: 6px; 
            vertical-align: middle; 
            visibility: hidden; 
            padding: 2px; 
        }
        .grid-table tr:hover .del-row-btn { visibility: visible; }
        
        .grid-add-btn { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: #fdfdfd; 
            color: #f9c22e; 
            font-weight: bold; 
            cursor: pointer; 
            transition: 0.2s; 
            text-shadow: 0 0 1px #999; 
            font-size: 20px; 
            position: relative; 
            z-index: 2; 
        }
        .grid-add-btn:hover { background: #eee; }

        /* --- Icons --- */
        .fake-icon { 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            width: 18px; 
            height: 18px; 
            border: 2px solid #ccc; 
            background: #fff; 
            cursor: pointer; 
            flex-shrink: 0; 
            font-size: 14px; 
            color: transparent; 
            font-weight: bold; 
            transition: 0.2s; 
            user-select: none; 
            position: relative; 
            z-index: 2; 
        }
        .fake-icon:hover { border-color: #999; }
        .fake-icon.radio { border-radius: 50%; }
        .fake-icon.checkbox { border-radius: 4px; }
        .fake-icon.checked-v { 
            border-color: var(--p); 
            background-color: #f0f7ff; 
            color: var(--p); 
        } 
        .fake-icon.checked-v::after { content: 'âœ“'; }
        
        .fake-icon.checked-x { 
            border-color: var(--danger); 
            background-color: #fff5f5; 
            color: var(--danger); 
            font-size: 12px; 
        } 
        .fake-icon.checked-x::after { content: 'âœ•'; }
        .fake-icon.radio.checked-x::after { content: 'âœ•'; }

        /* --- Option Layout --- */
        .opt-container { width: 100%; display: flex; gap: 8px; }
        .opt-container.vertical { flex-direction: column; }
        .opt-container.horizontal { flex-direction: row; flex-wrap: wrap; }
        .opt-container.horizontal .opt-item { min-width: 120px; }
        
        .opt-item { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            margin-top: 5px; 
            cursor: pointer; 
        }
        
        .preview-dropdown { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border: 1px solid #ccc; 
            padding: 10px; 
            border-radius: 8px; 
            background: #fff; 
            color: #666; 
            font-size: 14px; 
            cursor: pointer; 
        }
        
        /* --- Sidebar Elements --- */
        .p-item { margin-bottom: 15px; }
        .p-item label { 
            display: flex; 
            align-items: center; 
            font-weight: bold; 
            font-size: 13px; 
            margin-bottom: 5px; 
        }
        .inp-p { 
            width: 100%; 
            padding: 8px; 
            border: 1px solid var(--border); 
            border-radius: 6px; 
            font-size: 13px; 
        }
        .p-row-flex { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            margin-bottom: 8px; 
            flex-wrap: wrap; 
        }
        .p-check-row { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            font-size: 13px; 
            margin-bottom: 6px; 
            font-weight: 500; 
            cursor: pointer; 
        }
        
        .biu-btn { 
            border: 1px solid #ccc; 
            background: #fff; 
            padding: 6px 12px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-weight: bold; 
            font-size: 12px; 
        }
        .biu-btn.active { 
            background: #333; 
            color: #fff; 
            border-color: #333; 
        }
        
        .sec-divider { 
            margin-top: 15px; 
            border-top: 1px solid #eee; 
            padding-top: 10px; 
        }
        .add-link { 
            color: var(--p); 
            font-size: 12px; 
            font-weight: bold; 
            cursor: pointer; 
            margin-top: 8px; 
            display: inline-block; 
        }
        
        /* --- Logic Panel --- */
        .logic-panel { 
            background: #fffde7; 
            border: 1px dashed #fbc02d; 
            padding: 10px; 
            border-radius: 8px; 
            margin-top: 8px; 
        }
        .logic-line { 
            display: flex; 
            align-items: center; 
            gap: 6px; 
            margin-bottom: 6px; 
            font-size: 12px; 
            flex-wrap: nowrap; 
            width: 100%; 
        }
        .val-rule-item { 
            display: flex; 
            align-items: center; 
            gap: 4px; 
            margin-bottom: 6px; 
            background: #fdfdfd; 
            padding: 4px; 
            border-radius: 4px; 
            border: 1px solid #eee; 
            flex-wrap: nowrap; 
            width: 100%; 
        }
        .opt-manage-item { 
            display: flex; 
            align-items: center; 
            gap: 5px; 
            margin-bottom: 6px; 
            cursor: move; 
            background: #fff; 
            padding: 4px; 
            border: 1px solid #eee; 
            border-radius: 4px; 
        }
        .opt-drag-handle { 
            color: #ccc; 
            cursor: move; 
            margin-right: 4px; 
        }
        
        /* --- Footer & Actions (Updated) --- */
        .footer-actions { 
            margin-top: 30px; 
            width: 100%; 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
            border-top: 2px solid #eee; 
            padding-top: 20px; 
        }
        .action-row { 
            display: flex; 
            gap: 10px; 
            width: 100%; 
        }
        .btn-temp { 
            flex: 1; 
            background: var(--temp-btn); 
            color: #000; 
            border: 1px solid #e0a800; 
            padding: 12px; 
            border-radius: 6px; 
            font-weight: bold; 
            cursor: pointer; 
            text-align: center; 
        }
        .btn-submit { 
            flex: 2; 
            background: var(--submit-btn); 
            color: #fff; 
            border: none; 
            padding: 12px; 
            border-radius: 6px; 
            font-weight: bold; 
            cursor: pointer; 
            text-align: center; 
        }
        
        .temp-record-list { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 10px; 
            font-size: 12px; 
            border: 1px solid #ddd; 
            background: #fff; 
        }
        .temp-record-list th { 
            background: #f1f3f4; 
            padding: 8px; 
            text-align: left; 
            border-bottom: 2px solid #ddd; 
        }
        .temp-record-list td { 
            padding: 8px; 
            border-bottom: 1px solid #eee; 
            vertical-align: top; 
        }
        .temp-actions span { 
            color: var(--p); 
            cursor: pointer; 
            margin-right: 8px; 
            font-weight: bold; 
        }
        .temp-actions span.del { color: var(--danger); }

        /* --- Palette & Modal (Full Restored) --- */
        .palette-btn { 
            display: flex; 
            align-items: center; 
            gap: 2px; 
            padding: 2px 4px; 
            border: 1px solid transparent; 
            border-radius: 3px; 
            cursor: pointer; 
            background: transparent; 
            transition: 0.1s; 
            position: relative; 
            height: 32px; 
        }
        .palette-btn:hover { 
            background: #e0e0e0; 
            border-color: #ccc; 
        }
        .palette-popover { 
            display: none; 
            position: absolute; 
            top: 35px; 
            left: 0; 
            background: #fff; 
            border: 1px solid #bababa; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); 
            padding: 6px; 
            border-radius: 2px; 
            z-index: 3000; 
            width: 190px; 
        }
        .palette-popover.active { display: block; }
        
        .color-grid { 
            display: grid; 
            grid-template-columns: repeat(5, 1fr); 
            gap: 4px; 
        }
        .color-cell { 
            width: 28px; 
            height: 28px; 
            border: 1px solid #ddd; 
            cursor: pointer; 
        }
        .color-cell:hover { 
            outline: 1px solid #ff9800; 
            transform: scale(1.1); 
        }
        
        /* Modal Styles */
        .modal-overlay { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            z-index: 2000; 
            justify-content: center; 
            align-items: center; 
        }
        .modal-content { 
            background: #fff; 
            width: 90%; 
            max-width: 600px; 
            height: 80vh; 
            border-radius: 8px; 
            display: flex; 
            flex-direction: column; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); 
        }
        .modal-header { 
            padding: 15px; 
            border-bottom: 1px solid #eee; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            font-weight: bold; 
            font-size: 16px; 
        }
        .modal-body { 
            flex: 1; 
            overflow-y: auto; 
            padding: 15px; 
        }
        .modal-footer { 
            padding: 15px; 
            border-top: 1px solid #eee; 
            text-align: right; 
            background: #f9f9f9; 
            border-radius: 0 0 8px 8px; 
        }
        
        /* --- Unit Dropdown --- */
        .unit-label-container { 
            display: flex; 
            align-items: center; 
            background: #f0f0f0; 
            border-left: 1px solid #ccc; 
            position: relative; 
        }
        .unit-text-display { 
            padding: 0 8px; 
            font-size: 12px; 
            color: #555; 
            white-space: nowrap; 
        }
        .unit-dropdown-menu { 
            position: absolute; 
            top: 100%; 
            right: 0; 
            min-width: 80px; 
            background: #fff; 
            border: 1px solid #ccc; 
            box-shadow: 0 3px 8px rgba(0,0,0,0.15); 
            z-index: 100; 
            display: none; 
            flex-direction: column; 
            border-radius: 4px; 
        }
        .unit-dropdown-menu.active { display: flex; }
        .unit-option { 
            padding: 6px 10px; 
            font-size: 12px; 
            cursor: pointer; 
            transition: 0.1s; 
        }
        .unit-option:hover { background: #444; color: #fff; }
        
        .ui-hint-badge { 
            display: inline-block; 
            font-size: 10px; 
            padding: 1px 4px; 
            border-radius: 3px; 
            margin-left: 5px; 
            background-color: #f1f3f4; 
            color: #5f6368; 
            border: 1px solid #dadce0; 
            vertical-align: middle; 
        }
        
        .card-tools { 
            display: flex; 
            justify-content: flex-end; 
            gap: 15px; 
            margin-top: 15px; 
            padding-top: 10px; 
            border-top: 1px solid #f0f0f0; 
        }
        .tool-action { 
            font-size: 12px; 
            color: #666; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 4px; 
            font-weight: 600; 
        }
        .tool-action:hover { color: var(--p); }
    </style>
</head>
<body>

    <div class="preview-bar">
        <span>ğŸ‘ï¸ ç›®å‰ç‚ºé è¦½æ¨¡å¼ï¼šè«‹æ¸¬è©¦å¡«å¯«èˆ‡é©—è­‰ (ç·¨è¼¯åŠŸèƒ½å·²éš±è—)</span>
        <button class="btn-main" style="width:auto; padding:6px 15px; background:#444; color:#fff;" onclick="togglePreviewMode()">âŒ é€€å‡ºé è¦½</button>
    </div>

    <div id="tempConfigModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <span>âš™ï¸ è¨­å®šæš«å­˜èˆ‡çµ±è¨ˆè¦å‰‡</span>
                <span style="cursor:pointer;" onclick="closeTempModal()">âœ•</span>
            </div>
            <div class="modal-body">
                <div style="padding:10px; color:#666; font-size:13px; line-height:1.6;">
                    <b>èªªæ˜ï¼š</b><br>
                    æ­¤ç‚ºé€²éšè¨­å®šå€ï¼ˆä¿ç•™ v62.23 çš„å®Œæ•´ä»‹é¢æ¡†æ¶ï¼‰ï¼Œå¯ç”¨æ–¼ï¼š<br>
                    1. æš«å­˜åˆ—è¡¨é¡¯ç¤ºæ¬„ä½è¨­å®š<br>
                    2. çµ±è¨ˆæ¬„ä½èˆ‡è¨ˆç®—è¦å‰‡<br>
                    3. è‡ªå‹•æ¸…ç©ºæ’ç¨‹<br><br>
                    <i>(ç›®å‰é‚è¼¯èˆ‡å±¬æ€§é¢æ¿çš„ã€Œé€å‡ºèˆ‡æš«å­˜è¨­å®šã€é€£å‹•)</i>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-main btn-blue" style="width:auto; padding:8px 20px;" onclick="closeTempModal()">ç¢ºèªå„²å­˜</button>
            </div>
        </div>
    </div>

    <div class="sidebar-l">
        <div class="scroll-area">
            <button class="btn-main" style="background:#333; color:#fff; margin-bottom:10px;" onclick="togglePreviewMode()">ğŸ‘ï¸ é–‹å•Ÿé è¦½æ¨¡å¼</button>
            <h3>æ¬„ä½é¡å‹</h3>
            <div class="cat">è¼¸å…¥èˆ‡å·¥æ¥­</div>
            <button class="btn-t" onclick="hAdd('text')">ğŸ“ æ–‡å­—æ¡†</button>
            <button class="btn-t" onclick="hAdd('batch')">ğŸ”¢ æ‰¹è™Ÿ (å›ºå®šæ ¼å¼)</button>
            <button class="btn-t" onclick="hAdd('custom_row')">ğŸ§© è‡ªè¨‚çµ„åˆ (è‡ªç”±è¨­è¨ˆ)</button>
            <button class="btn-t" onclick="hAdd('machine')">ğŸ¤– æ©Ÿå°</button>
            <button class="btn-t" onclick="hAdd('remark')">ğŸ—¨ï¸ å‚™è¨»</button>
            <div class="cat">é¸æ“‡èˆ‡æ ¼é»</div>
            <button class="btn-t" onclick="hAdd('choices')">ğŸ”˜ å–®é¸ / å¤šé¸</button>
            <button class="btn-t" onclick="hAdd('dropdown')">ğŸ”½ ä¸‹æ‹‰é¸å–®</button>
            <button class="btn-t" onclick="hAdd('grid')">â–¦ ç¶œåˆæ ¼é»</button>
            <div class="cat">ç‰¹æ®ŠåŠŸèƒ½</div>
            <button class="btn-t" onclick="hAdd('datetime')">ğŸ“… æ—¥æœŸ & æ™‚é–“</button>
            <button class="btn-t" onclick="hAdd('shift')">ğŸ•’ ç­åˆ¥</button>
            <button class="btn-t" onclick="hAdd('header')">ğŸš© ç« ç¯€æ¨™é¡Œ</button>
        </div>
        <div style="padding:15px; border-top:1px solid var(--border)">
            <input type="file" id="jsonUp" style="display:none;" onchange="hImport(this)">
            <button class="btn-main" style="background:#fff; border:1px solid #ccc; margin-bottom:8px;" onclick="document.getElementById('jsonUp').click()">ğŸ“‚ åŒ¯å…¥ JSON</button>
            <button class="btn-main btn-blue" onclick="hExport()">ğŸš€ åŒ¯å‡º JSON</button>
        </div>
    </div>

    <div class="canvas-area">
        <div class="canvas-container">
            <div class="meta-card" id="formMetaCard" onmousedown="select('form_meta')">
                <textarea id="mT" class="title-inp no-drag" rows="1" style="font-size:1.8rem; font-weight:bold;" oninput="autoResize(this); syncMeta()" onfocus="select('form_meta')">æœªå‘½åçš„è¡¨å–®</textarea>
                <textarea id="mD" class="title-inp no-drag" rows="1" style="margin-top:10px; font-size:14px; font-weight:normal; display:none;" placeholder="è¼¸å…¥è¡¨å–®èªªæ˜..." oninput="autoResize(this); syncMeta()" onfocus="select('form_meta')"></textarea>
            </div>
            <div id="fList" class="sortable-list"></div>
            <div id="formFooter" class="footer-actions"></div>
        </div>
    </div>

    <div class="sidebar-r">
        <h3>å±¬æ€§è¨­å®š</h3>
        <div id="noSel" style="text-align:center; color:#999; margin-top:50px;">é»é¸æ¬„ä½æˆ–æ¨™é¡Œé–‹å§‹ç·¨è¼¯</div>
        
        <div id="formSettings" style="display:none;">
            <div class="p-item">
                <div style="margin-top:5px; border-bottom:1px dashed #eee; padding-bottom:10px; margin-bottom:10px;">
                     <label style="font-size:12px; color:#666;">æ–‡å­—æ¨£å¼</label>
                     <div class="p-row-flex">
                        <input type="number" class="inp-p" id="mSize" style="width:50px" value="28" oninput="applyGlobal()">
                        <div id="metaPaletteContainer" style="display:flex; gap:2px;"></div> 
                     </div>
                </div>
                <label>é€å‡ºèˆ‡æš«å­˜è¨­å®š</label>
                <label class="p-check-row"><input type="checkbox" id="gEnableTemp" onchange="applyGlobal()"> å•Ÿç”¨æš«å­˜ç´€éŒ„åˆ—è¡¨</label>
                <div id="tempConfigBtn" style="display:none; margin-top:8px;">
                     <button class="btn-main" style="background:#e8f0fe; color:#1a73e8; border:1px solid #d2e3fc;" onclick="openTempModal()">âš™ï¸ è¨­å®šæš«å­˜èˆ‡çµ±è¨ˆè¦å‰‡</button>
                </div>
            </div>
            <div class="p-item sec-divider">
                <label>æ’ç‰ˆèˆ‡èªªæ˜</label>
                <select class="inp-p" id="gLayout" onchange="applyGlobal()">
                    <option value="horizontal">æ©«å¼ (æ¨™é¡Œåœ¨åˆ—)</option>
                    <option value="vertical">ç›´å¼ (æ¨™é¡Œåœ¨æ¬„)</option>
                </select>
                <label class="p-check-row" style="margin-top:10px;"><input type="checkbox" id="gMetaDescE" onchange="applyGlobal()"> å•Ÿç”¨è¡¨å–®èªªæ˜</label>
            </div>
        </div>

        <div id="editor" style="display:none;">
            <div class="p-item">
                <label>åŸºæœ¬å±¬æ€§</label>
                <div class="p-row-flex">
                    <input type="number" class="inp-p" id="pSize" style="width:50px" placeholder="Size" oninput="apply()">
                    <div id="editorPaletteContainer" style="display:flex; gap:2px;"></div>
                    <select class="inp-p" id="pWidth" style="flex:1" onchange="apply()">
                        <option value="w-100">100% å…¨å¯¬</option>
                        <option value="w-50">50% åŠå¯¬</option>
                        <option value="w-33">33% 1/3å¯¬</option>
                    </select>
                </div>
                <label class="p-check-row"><input type="checkbox" id="pReq" onchange="apply()"> å¿…å¡« (*)</label>
                <label class="p-check-row"><input type="checkbox" id="pDescE" onchange="apply()"> å•Ÿç”¨èªªæ˜æ–‡å­—</label>
            </div>

            <div id="customRowSec" class="p-item sec-divider" style="display:none; background:#f0f9ff; padding:10px; border-radius:6px;">
                <label>è‡ªè¨‚çµ„åˆå…ƒä»¶</label>
                <div style="font-size:11px; color:#666; margin-bottom:5px;">é»æ“Šä¸‹æ–¹æŒ‰éˆ•åŠ å…¥å…ƒä»¶è‡³å–®è¡Œï¼š</div>
                <div style="display:flex; gap:5px; margin-bottom:10px;">
                    <button class="biu-btn" onclick="addCustomElem('check')">+å‹¾é¸</button>
                    <button class="biu-btn" onclick="addCustomElem('text')">+æ¨™ç±¤</button>
                    <button class="biu-btn" onclick="addCustomElem('input')">+è¼¸å…¥æ¡†</button>
                </div>
                <div id="customElemList"></div>
            </div>

            <div id="modeSec" class="p-item sec-divider">
                <label>é¡¯ç¤ºæ¨£å¼</label>
                <select class="inp-p" id="pMode" onchange="apply()">
                    <option value="radio">å–®é¸ (åœ“éˆ•)</option>
                    <option value="checkbox">å¤šé¸ (æ–¹æ¡†)</option>
                    <option value="mixed-radio">æ··åˆå–®é¸ (åœ“éˆ•+æ–‡å­—)</option>
                    <option value="mixed-checkbox">æ··åˆå¤šé¸ (æ–¹æ¡†+æ–‡å­—)</option>
                </select>
            </div>
            
            <div id="machineStyleSec" class="p-item sec-divider" style="display:none;">
                <label>æ©Ÿå°é¡¯ç¤ºæ¨£å¼</label>
                <select class="inp-p" id="pMachineStyle" onchange="apply()">
                    <option value="dropdown">ä¸‹æ‹‰å¼é¸å–®</option>
                    <option value="radio">å–®é¸</option>
                    <option value="checkbox">å¤šé¸</option>
                    <option value="text">æ–‡å­—æ¡†</option>
                    <option value="mixed-radio">æ··åˆå–®é¸</option>
                    <option value="mixed-checkbox">æ··åˆå¤šé¸</option>
                </select>
            </div>

            <div id="markStyleSec" class="p-item sec-divider" style="display:none;">
                <label>æ¨™è¨˜æ¨£å¼</label>
                <select class="inp-p" id="pMarkStyle" onchange="apply()">
                    <option value="mark-check">æ‰“å‹¾ (é è¨­)</option>
                    <option value="mark-cross">æ‰“å‰</option>
                    <option value="mark-both">æ‰“å‹¾æˆ–æ‰“å‰ (ä¸‰æ…‹)</option>
                </select>
            </div>

            <div id="optSec" class="p-item sec-divider" style="display:none;">
                <label>é¸é …ç®¡ç†</label>
                <div id="optLayoutContainer" style="margin-bottom:8px;">
                     <div style="display:flex; align-items:center; gap:8px;">
                        <span style="font-size:12px; color:#666;">æ’åˆ—æ–¹å‘:</span>
                        <select id="pOptLayout" style="font-size:12px; padding:2px;" onchange="apply()">
                            <option value="vertical">ç›´å¼ (å‚ç›´)</option>
                            <option value="horizontal">æ©«å¼ (æ°´å¹³)</option>
                        </select>
                    </div>
                </div>
                <div id="optList"></div>
                <div style="display:flex; gap:10px;">
                    <span class="add-link" onclick="addSidebarOpt()">+ æ–°å¢é¸é …</span>
                    <span class="add-link" onclick="bulkAddSidebarOpt()">+ æ‰¹é‡æ–°å¢</span>
                </div>
            </div>

            <div id="machineLogicSec" class="p-item sec-divider" style="display:none; background:#f0f9ff; padding:10px; border-radius:6px;">
                <label>æ™ºæ…§é€£å‹•è¦å‰‡ (é¸Aå‡ºç¾B)</label>
                <div id="mRules"></div>
                <span class="add-link" onclick="addMachineRule()">+ æ–°å¢é€£å‹•è¦å‰‡</span>
            </div>

            <div id="contentSec" class="p-item sec-divider">
                <label>å…§å®¹é™åˆ¶èˆ‡æ ¼å¼</label>
                <div id="excelKeyRow" style="margin-bottom:8px;">
                     <input type="text" class="inp-p" id="pExcelKey" placeholder="Excel å°æ‡‰æ¬„ä½å (è‹±æ•¸)" oninput="apply()">
                </div>
                <div id="defValRow">
                    <input type="text" class="inp-p" id="pDefVal" placeholder="é è¨­å€¼" oninput="apply()">
                </div>
                <label class="p-check-row"><input type="checkbox" id="pUpperCase" onchange="apply()"> å¼·åˆ¶å¤§å¯«</label>
                
                <div style="margin-top:10px; background:#fff3e0; padding:8px; border-radius:4px; border:1px solid #ffe0b2;">
                    <label style="color:#e65100; margin-bottom:4px;">å…§å®¹é©—è­‰è¦å‰‡ (NG å¡é—œ)</label>
                    <div id="valRulesList"></div>
                    <span class="add-link" onclick="addValRule()">+ æ–°å¢è¦å‰‡</span>
                </div>
            </div>

             <div id="gridSec" class="p-item sec-divider" style="display:none;">
                <label>æ ¼é»è¨­å®š</label>
                <label class="p-check-row"><input type="checkbox" id="pCorner" onchange="apply()"> é¡¯ç¤ºæ–œç·šè¡¨é ­</label>
                <label class="p-check-row"><input type="checkbox" id="pShowCol" onchange="apply()"> é¡¯ç¤ºæ¬„æ¨™é¡Œ</label>
                <label class="p-check-row"><input type="checkbox" id="pShowRow" onchange="apply()"> é¡¯ç¤ºåˆ—æ¨™é¡Œ</label>
            </div>

            <div id="unitSec" class="p-item sec-divider" style="display:none;">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <label style="margin:0;">å–®ä½èˆ‡è¦å‰‡</label>
                    <label style="font-size:12px;"><input type="checkbox" id="pManual" onchange="apply()"> å…è¨±æ‰‹å‹•è®Šæ›´</label>
                </div>
                <label class="p-check-row"><input type="checkbox" id="pUnitE" onchange="apply()"> å•Ÿç”¨å–®ä½</label>
                <input type="text" class="inp-p" id="pUnitB" placeholder="é è¨­å–®ä½ (å¦‚ pcs)" oninput="updateUnitB(this.value)">
                <div id="uLogic" class="logic-panel" style="display:none;">
                    <div id="uRules"></div>
                    <span class="add-link" onclick="addURule()">+ æ–°å¢å–®ä½åˆ¤æ–·</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        let fields = [];
        let activeId = null;
        let formConfig = { layout: 'horizontal', enableTemp: false, metaDescE: false, metaStyle: { size: 28, color: '#000000', bgColor: 'transparent', bold: true } };
        let mockTempData = [];
        let isPreviewMode = false;
        
        const list = document.getElementById('fList');
        
        /* --- Initialization --- */
        new Sortable(list, {
            animation: 150, handle: '.card', filter: '.no-drag, input, textarea, button, select', preventOnFilter: false,
            onEnd: () => {
                const order = Array.from(list.children).map(el => el.dataset.id);
                fields = order.map(id => fields.find(x => x.id === id)).filter(Boolean);
            }
        });

        const getPaletteHTML = (idPrefix, targetType, currentColor, indicatorId) => `
            <div style="position:relative; z-index:50;">
                <div class="palette-btn" onclick="togglePalette('${idPrefix}', event)" title="${targetType==='text'?'æ–‡å­—é¡è‰²':'æ–‡å­—èƒŒæ™¯'}">
                    <div style="display:flex; flex-direction:column; align-items:center; width:20px;">
                        ${targetType==='text' ? 'A' : 'â¬›'}
                        <div id="${indicatorId}" style="width:100%; height:3px; background:${currentColor}; margin-top:2px;"></div>
                    </div>
                    <span style="font-size:10px;">â–¼</span>
                </div>
                <div id="pal${idPrefix}" class="palette-popover">
                    <div class="color-grid">
                        ${['#000000','#ffffff','#d93025','#f9ab00','#34a853','#1a73e8','#a142f4'].map(c => 
                            `<div class="color-cell" style="background:${c};" onclick="updateColor('${targetType}','${c}', '${idPrefix}')"></div>`
                        ).join('')}
                    </div>
                    <div style="padding-top:5px; border-top:1px solid #eee; margin-top:5px;">
                         <input type="color" oninput="updateColor('${targetType}', this.value, '${idPrefix}')" style="width:100%;">
                    </div>
                </div>
            </div>`;

        /* --- Logic Functions --- */
        function createFieldModel(type) {
            const id = 'f' + Date.now();
            let title = (type==='batch')?'æ‰¹è™Ÿ':(type==='shift')?'ç­åˆ¥':(type==='machine')?'æ©Ÿå°':(type==='remark')?'å‚™è¨»':'æœªå‘½åçš„æ¬„ä½';
            if(type==='header') title='ç« ç¯€æ¨™é¡Œ';
            if(type==='custom_row') title='è‡ªè¨‚çµ„åˆ';

            return {
                id, type, title, width:'w-100', size:14, color:'#000000', bgColor:'transparent', req:false, descE:false, desc:'', 
                excelKey: '', defVal: '', upper: false,
                mode: 'text', markStyle: 'mark-check', optLayout: 'vertical',
                opts: ['é¸é … 1'],
                machineStyle: 'dropdown', machineRules: [],
                rows: ['Row 1'], cols: ['Col 1'], cellModes: [['text']], showCol:true, showRow:true, corner:true, cornerTop:'æ¬„', cornerBot:'åˆ—',
                valRules: [], unitB: '', uEnable: false, manual: false, uRules: [],
                customElems: type==='custom_row' ? [{type:'check', label:'æª¢æŸ¥'}, {type:'input', width:100, placeholder:'æ•¸å€¼'}] : [],
                shiftRules: [], showTime: false, autoDate: false
            };
        }

        function hAdd(type) {
            const f = createFieldModel(type);
            fields.push(f);
            render();
            setTimeout(() => select(f.id), 50);
        }

        /* --- Core Render --- */
        function render() {
            const mCard = document.getElementById('formMetaCard');
            const mT = document.getElementById('mT');
            mT.style.fontSize = (formConfig.metaStyle.size) + 'px';
            mT.style.color = formConfig.metaStyle.color;
            mT.style.backgroundColor = formConfig.metaStyle.bgColor;
            document.getElementById('mD').style.display = formConfig.metaDescE ? 'block' : 'none';
            if(activeId === 'form_meta') mCard.classList.add('selected'); else mCard.classList.remove('selected');

            const htmlArr = fields.map(f => {
                const isSel = activeId === f.id;
                const s = `font-size:${f.size}px; color:${f.color}; background-color:${f.bgColor};`;
                
                // Helper to render basic input
                const renderInput = (cls, ph, val, extra='') => 
                    `<div style="position:relative; width:100%; flex:1;">
                        <input class="${cls} ${isPreviewMode?'':'no-drag'}" style="width:100%; border:1px solid #ccc; border-radius:4px; padding:4px 6px; font-size:12px; height:28px; background:#fff; ${f.upper?'text-transform:uppercase':''}" 
                        placeholder="${ph}" value="${val||''}" data-fid="${f.id}" onblur="validateInput(this, '${f.id}')" oninput="clearError(this); ${f.upper?'this.value=this.value.toUpperCase()':''}" ${extra}>
                        <div class="err-msg" id="err_${f.id}"></div>
                     </div>`;
                     
                const renderMark = (isRadio, style) => 
                    `<div class="fake-icon ${isRadio?'radio':'checkbox'} ${isPreviewMode?'':'no-drag'}" onclick="toggleCheck(this, '${style}', ${isRadio}, '${f.id}')"></div>`;

                let body = '';
                
                if(f.type === 'text') {
                    let unitHtml = '';
                    if(f.uEnable) {
                        unitHtml = `<div class="unit-label-container" onclick="toggleUnitDropdown('${f.id}', event)"><div class="unit-text-display" id="unitDisplay_${f.id}">${f.unitB||'-'}</div>${f.manual?'<div class="manual-arrow">â–¼</div>':''}</div><div id="unitDrop_${f.id}" class="unit-dropdown-menu"></div>`;
                    }
                    body = `<div style="display:flex; border:1px solid #ccc; border-radius:4px; position:relative;">${renderInput('style-v27-box','è«‹è¼¸å…¥...', f.defVal)}${unitHtml}</div>`;
                } 
                else if(f.type === 'batch') {
                    // Fixed: Added stopPropagation
                    body = `<div class="batch-container">
                        <label class="batch-label" onclick="event.stopPropagation();"><div class="fake-icon checkbox ${isPreviewMode?'':'no-drag'}" onclick="toggleCheck(this, 'mark-check');"></div> FA</label>
                        ${renderInput('batch-input-flex', 'ä¸»(3)', '', 'maxlength="3" style="text-align:center"')} 
                        <span>-</span> 
                        ${renderInput('batch-input-flex', 'å­(2)', '', 'maxlength="2" style="text-align:center"')}
                    </div>`;
                }
                else if(f.type === 'custom_row') {
                    // Custom Row
                    body = `<div class="batch-container">
                        ${(f.customElems||[]).map(el => {
                            if(el.type==='check') return `<label class="batch-label" onclick="event.stopPropagation()"><div class="fake-icon checkbox ${isPreviewMode?'':'no-drag'}" onclick="toggleCheck(this, 'mark-check')"></div> ${el.label||''}</label>`;
                            if(el.type==='text') return `<span style="font-size:13px; font-weight:bold; margin:0 4px;">${el.label||''}</span>`;
                            if(el.type==='input') return `<div style="flex:${el.flex?1:'none'}; width:${el.width||80}px;">${renderInput('batch-input-flex', el.placeholder||'', '', 'style="text-align:center"')}</div>`;
                        }).join('')}
                    </div>`;
                }
                else if(f.type === 'choices' || f.type === 'machine' || f.type === 'shift') {
                    let style = f.mode;
                    if(f.type === 'machine') style = f.machineStyle;
                    if(f.type === 'shift' && !style) style = 'dropdown';

                    if(style === 'dropdown') {
                        body = `<div class="preview-dropdown" onclick="select('${f.id}')"><select class="${isPreviewMode?'':'no-drag'}" style="width:100%; border:none; background:transparent;" onchange="if('${f.type}'==='machine') runMachineLogic('${f.id}', this.value)"><option>-- è«‹é¸æ“‡ --</option>${(f.opts||[]).map(o=>`<option value="${o}">${o}</option>`).join('')}</select></div>`;
                    } else if(style === 'text') {
                         body = `<div class="opt-container ${f.optLayout||'vertical'}">${(f.opts||[]).map(o=>`<div class="opt-item"><span>${o}</span> ${renderInput('style-v27-box','')}</div>`).join('')}</div>`;
                    } else {
                        const isRadio = style.includes('radio');
                        const isMixed = style.includes('mixed');
                        body = `<div class="opt-container ${f.optLayout||'vertical'}">
                            ${(f.opts||[]).map(o => `
                                <div class="opt-item" onclick="if('${f.type}'==='machine') runMachineLogic('${f.id}', '${o}'); if(!event.target.closest('input')) toggleCheck(this.querySelector('.fake-icon'), '${f.markStyle}', ${isRadio}, '${f.id}')">
                                    ${renderMark(isRadio, f.markStyle)} 
                                    <span>${o}</span> 
                                    ${isMixed ? renderInput('style-v27-box','') : ''}
                                </div>`).join('')}
                        </div>`;
                    }
                }
                else if(f.type === 'remark') {
                    body = `<textarea class="remark-box ${isPreviewMode?'':'no-drag'}" placeholder="å‚™è¨»...">${f.defVal||''}</textarea>`;
                }
                else if(f.type === 'grid') {
                     let thead = f.showCol ? `<thead><tr>${f.corner?`<th class="slash-header"><span class="slash-top">${f.cornerTop}</span><span class="slash-bot">${f.cornerBot}</span></th>`:'<th></th>'}${f.cols.map((c,i)=>`<th>${c}<span class="del-col-btn no-drag" onclick="delCol('${f.id}',${i})">Ã—</span></th>`).join('')}<th class="grid-add-btn no-drag" onclick="addCol('${f.id}')">+</th></tr></thead>` : '';
                     let tbody = f.rows.map((r, ri) => `<tr>${f.showRow?`<td>${r}<span class="del-row-btn no-drag" onclick="delRow('${f.id}',${ri})">ğŸ—‘</span></td>`:''}
                        ${f.cols.map((c, ci) => {
                            let mode = (f.cellModes[ri] && f.cellModes[ri][ci]) || 'text';
                            if(mode==='text') return `<td>${renderInput('style-v27-box','')}</td>`;
                            return `<td><div class="grid-cell-wrapper">${renderMark(mode.includes('radio'), f.markStyle)}${mode.includes('mixed')?renderInput('style-v27-box',''):''}</div></td>`;
                        }).join('')}
                     </tr>`).join('');
                     body = `<table class="grid-table">${thead}<tbody>${tbody}<tr><td colspan="100" class="grid-add-btn no-drag" onclick="addRow('${f.id}')">+</td></tr></tbody></table>`;
                }

                let uiHints = `<span class="ui-hint-badge">${f.type.toUpperCase()}</span>`;
                if(f.req) uiHints += `<span class="ui-hint-badge" style="color:red">*å¿…å¡«</span>`;
                
                return `
                <div class="card ${f.width} ${isSel?'selected':''}" data-id="${f.id}" onmousedown="select('${f.id}')">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <div style="width:85%; display:flex; align-items:center; gap:4px;">
                            <textarea class="title-inp no-drag" rows="1" style="${s}" oninput="autoResize(this); updateField('${f.id}','title',this.value)">${f.title}</textarea>
                        </div>
                        ${uiHints}
                    </div>
                    ${f.descE ? `<div style="margin-bottom:8px;"><textarea class="desc-inp no-drag" rows="1" placeholder="èªªæ˜..." oninput="autoResize(this); updateField('${f.id}','desc',this.value)">${f.desc}</textarea></div>` : ''}
                    <div>${body}</div>
                    <div class="card-tools">
                        <span class="tool-action no-drag" onclick="copyF('${f.id}')">ğŸ“‹ è¤‡è£½</span>
                        <span class="tool-action no-drag" style="color:#d93025;" onclick="delF('${f.id}')">ğŸ—‘ åˆªé™¤</span>
                    </div>
                </div>`;
            }).join('');
            
            list.innerHTML = htmlArr;
            renderFooter();
        }

        /* --- Footer & Temp Logic (Simulated) --- */
        function renderFooter() {
            const footer = document.getElementById('formFooter');
            if(!formConfig.enableTemp) {
                // Not Enabled: Direct Submit
                footer.innerHTML = `<button class="btn-submit ${isPreviewMode?'':'no-drag'}" onclick="mockSubmit(true)">ç›´æ¥é€å‡ºè³‡æ–™ (è‡³ç¸½æª”)</button>`;
            } else {
                // Enabled: Temp Flow
                let tempListHtml = '';
                if(mockTempData.length > 0) {
                    tempListHtml = `
                    <div style="margin-top:10px; border:1px solid #ccc; padding:10px; border-radius:4px; background:#fff;">
                        <div style="font-weight:bold; margin-bottom:5px;">ğŸ“‹ æš«å­˜ç´€éŒ„åˆ—è¡¨</div>
                        <table class="temp-record-list">
                            <thead><tr><th>#</th><th>å…§å®¹æ‘˜è¦ (æ¨¡æ“¬)</th><th>æ“ä½œ</th></tr></thead>
                            <tbody>
                                ${mockTempData.map((d, i) => `<tr>
                                    <td>${i+1}</td>
                                    <td>${JSON.stringify(d).substring(0, 30)}...</td>
                                    <td class="temp-actions"><span onclick="loadTemp(${i})">ç·¨è¼¯</span><span class="del" onclick="delTemp(${i})">åˆªé™¤</span></td>
                                </tr>`).join('')}
                            </tbody>
                        </table>
                    </div>`;
                }

                footer.innerHTML = `
                <div class="action-row">
                    <button class="btn-temp ${isPreviewMode?'':'no-drag'}" onclick="mockAddToTemp()">ğŸ’¾ æš«å­˜å–®ç­†ç´€éŒ„</button>
                    <button class="btn-submit ${isPreviewMode?'':'no-drag'}" onclick="mockSubmit(false)">ğŸš€ é€å‡ºæ‰€æœ‰è³‡æ–™</button>
                </div>
                ${tempListHtml}`;
            }
        }

        function mockAddToTemp() {
            if(!checkValidation()) return;
            // Simulate collecting data
            const data = { id: Date.now(), timestamp: new Date().toLocaleTimeString() };
            mockTempData.push(data);
            alert(`âœ… è³‡æ–™å·²å¯«å…¥ã€Œç³»çµ±æš«å­˜å€ Sheetã€ï¼\nç›®å‰æš«å­˜ç­†æ•¸ï¼š${mockTempData.length}`);
            renderFooter();
        }

        function mockSubmit(direct) {
            if(direct) {
                 if(!checkValidation()) return;
                 alert("ğŸš€ è³‡æ–™å·²ç›´æ¥å¯«å…¥ã€Œç¸½æª” Sheetã€ï¼");
            } else {
                if(mockTempData.length === 0) { alert("âš ï¸ æš«å­˜å€ç„¡è³‡æ–™ï¼Œç„¡æ³•é€å‡ºï¼"); return; }
                if(confirm(`ç¢ºèªå°‡ ${mockTempData.length} ç­†æš«å­˜è³‡æ–™è½‰å…¥ã€Œç¸½æª”ã€ä¸¦æ¸…ç©ºæš«å­˜å€ï¼Ÿ`)) {
                    mockTempData = [];
                    renderFooter();
                    alert("ğŸš€ ç§»è½‰å®Œæˆï¼æš«å­˜å€å·²æ¸…ç©ºã€‚");
                }
            }
        }

        function delTemp(index) {
            if(confirm("ç¢ºå®šåˆªé™¤æ­¤ç­†æš«å­˜ï¼Ÿ")) {
                mockTempData.splice(index, 1);
                renderFooter();
            }
        }

        function loadTemp(index) {
            alert("ğŸ”„ (æ¨¡æ“¬) è³‡æ–™å·²è¼‰å›è¡¨å–®ä¾›ç·¨è¼¯ã€‚");
        }

        /* --- Validation (Fixed Logic) --- */
        function validateInput(inp, id) {
            const f = fields.find(x => x.id === id);
            if(!f) return;
            const val = inp.value;
            const errDiv = document.getElementById(`err_${id}`);
            let error = null;

            if(f.req && !val.trim()) error = "æ­¤æ¬„ä½å¿…å¡«";

            if(!error && f.valRules.length > 0 && val.trim() !== "") {
                const num = parseFloat(val);
                const len = val.length;
                
                f.valRules.forEach(r => {
                    if(r.target === 'val') {
                         if(r.op1 && !checkOp(num, r.op1, parseFloat(r.val1))) error = `æ•¸å€¼éœ€ ${r.op1} ${r.val1}`;
                         if(!error && r.op2 && !checkOp(num, r.op2, parseFloat(r.val2))) error = `æ•¸å€¼éœ€ ${r.op2} ${r.val2}`;
                    } else if(r.target === 'len') {
                        // Fix for Len 77777 (5) logic
                        if(r.op1 && !checkOp(len, r.op1, parseFloat(r.val1))) error = `å­—æ•¸éœ€ ${r.op1} ${r.val1}`;
                        if(!error && r.op2 && !checkOp(len, r.op2, parseFloat(r.val2))) error = `å­—æ•¸éœ€ ${r.op2} ${r.val2}`;
                    }
                });
            }

            if(error) {
                inp.classList.add('error-border');
                if(errDiv) { errDiv.textContent = `NG: ${error}`; errDiv.classList.add('show'); }
                // Propagate error to card
                const card = document.querySelector(`.card[data-id="${id}"]`);
                if(card) card.classList.add('error-state');
            } else {
                clearError(inp);
            }
        }

        function clearError(inp) {
            inp.classList.remove('error-border');
            const id = inp.getAttribute('data-fid');
            const errDiv = document.getElementById(`err_${id}`);
            if(errDiv) { errDiv.classList.remove('show'); }
            const card = document.querySelector(`.card[data-id="${id}"]`);
            if(card) card.classList.remove('error-state');
        }

        function checkOp(a, op, b) {
            if(op==='>') return a>b; if(op==='<') return a<b; if(op==='=') return a===b;
            if(op==='>=') return a>=b; if(op==='<=') return a<=b; return true;
        }

        function checkValidation() {
            document.querySelectorAll('input[onblur]').forEach(i => {
                const fid = i.getAttribute('data-fid');
                validateInput(i, fid);
            });
            const errors = document.querySelectorAll('.error-border');
            if(errors.length > 0) {
                alert("âš ï¸ è¡¨å–®å«æœ‰éŒ¯èª¤ (NG) è³‡æ–™ï¼Œè«‹ä¿®æ­£å¾Œå†æäº¤ã€‚");
                return false;
            }
            return true;
        }

        /* --- UI Interactions (Palette, Tri-state, Machine) --- */
        function togglePalette(id, event) {
            if(event) event.stopPropagation();
            const pop = document.getElementById('pal'+id);
            if(!pop) return;
            document.querySelectorAll('.palette-popover').forEach(p => { if(p.id!=='pal'+id) p.classList.remove('active'); });
            pop.classList.toggle('active');
        }
        function updateColor(type, color, idPrefix) {
            document.getElementById('ind'+idPrefix).style.backgroundColor = color;
            if(activeId === 'form_meta') {
                if(type === 'text') formConfig.metaStyle.color = color;
                if(type === 'bg') formConfig.metaStyle.bgColor = color;
            } else {
                const f = fields.find(x => x.id === activeId);
                if(f) { if(type === 'text') f.color = color; if(type === 'bg') f.bgColor = color; }
            }
            render();
            document.querySelectorAll('.palette-popover').forEach(p => p.classList.remove('active'));
        }
        document.addEventListener('click', function(e) {
            if(!e.target.closest('.palette-btn') && !e.target.closest('.palette-popover')) {
                document.querySelectorAll('.palette-popover').forEach(p => p.classList.remove('active'));
            }
        });

        /* Fix: Tri-State Logic */
        function toggleCheck(el, style, isRadio, fid) {
            event.stopPropagation();
            
            if(isRadio) {
                const container = el.closest('.opt-container') || el.closest('.grid-cell-wrapper');
                if(container) {
                    container.querySelectorAll('.fake-icon').forEach(i => i.classList.remove('checked-v', 'checked-x'));
                }
            }
            
            if(style === 'mark-both') {
                // Tri-state: Empty -> V -> X -> Empty
                if(el.classList.contains('checked-v')) {
                    el.classList.remove('checked-v');
                    el.classList.add('checked-x');
                } else if(el.classList.contains('checked-x')) {
                    el.classList.remove('checked-x');
                } else {
                    el.classList.add('checked-v');
                }
            } else if(style === 'mark-cross') {
                el.classList.toggle('checked-x');
            } else {
                el.classList.toggle('checked-v');
            }
        }

        function runMachineLogic(id, val) {
            const f = fields.find(x => x.id === id);
            if (!f || !f.machineRules) return;
            
            const rule = f.machineRules.find(r => r.val.split(',').includes(val));
            if(rule) {
                const targetIds = rule.target.split(',');
                targetIds.forEach(tid => {
                    let tf = fields.find(x => x.id === tid.trim());
                    if(tf) {
                        const newOpts = rule.targetOpts.split(',').map(s=>s.trim());
                        if(tf.type === 'grid') { 
                            tf.cols = newOpts; 
                            while(tf.cellModes[0].length < tf.cols.length) tf.cellModes.forEach(r => r.push('text'));
                        } else { 
                            tf.opts = newOpts; 
                        }
                    }
                });
                render(); 
                setTimeout(() => select(id), 50);
            }
        }

        function toggleUnitDropdown(id, event) {
            event.stopPropagation();
            const dd = document.getElementById('unitDrop_' + id);
            document.querySelectorAll('.unit-dropdown-menu').forEach(d => { if (d.id !== 'unitDrop_' + id) d.classList.remove('active'); });
            
            if (dd.classList.contains('active')) {
                dd.classList.remove('active');
                return;
            }
            
            const f = fields.find(x => x.id === id);
            let options = [];
            if(f.unitB) options.push(f.unitB);
            if(f.uRules) f.uRules.forEach(r => { if(r.res && !options.includes(r.res)) options.push(r.res); });
            
            dd.innerHTML = options.length ? options.map(opt => 
                `<div class="unit-option" onclick="document.getElementById('unitDisplay_${id}').textContent='${opt}'; document.getElementById('unitDrop_${id}').classList.remove('active');">${opt}</div>`
            ).join('') : '<div style="padding:5px; color:#999;">ç„¡é¸é …</div>';
            
            dd.classList.add('active');
        }

        /* --- Editor Select/Apply --- */
        function select(id) {
            if(isPreviewMode) return;
            
            activeId = id;
            document.getElementById('noSel').style.display='none';
            
            if(id === 'form_meta') {
                document.getElementById('formSettings').style.display = 'block';
                document.getElementById('editor').style.display = 'none';
                
                document.getElementById('mSize').value = formConfig.metaStyle.size;
                document.getElementById('metaPaletteContainer').innerHTML = getPaletteHTML('metaText', 'text', formConfig.metaStyle.color, 'indmetaText') + getPaletteHTML('metaBg', 'bg', formConfig.metaStyle.bgColor, 'indmetaBg');
                
                document.getElementById('gEnableTemp').checked = formConfig.enableTemp;
                document.getElementById('gLayout').value = formConfig.layout;
                document.getElementById('gMetaDescE').checked = formConfig.metaDescE;
                document.getElementById('tempConfigBtn').style.display = formConfig.enableTemp ? 'block' : 'none';
                return;
            }

            document.getElementById('formSettings').style.display='none';
            document.getElementById('editor').style.display='block';
            
            const f = fields.find(x => x.id === id);
            
            const setV = (eid, v) => document.getElementById(eid).value = v;
            const setC = (eid, v) => document.getElementById(eid).checked = v;

            setV('pSize', f.size);
            setV('pWidth', f.width);
            setV('pMode', f.mode);
            setV('pDefVal', f.defVal);
            setV('pExcelKey', f.excelKey || '');
            setV('pOptLayout', f.optLayout);
            setC('pReq', f.req);
            setC('pDescE', f.descE);
            setC('pUpperCase', f.upper);
            setC('pManual', f.manual);
            setC('pUnitE', f.uEnable);
            setV('pUnitB', f.unitB);
            
            document.getElementById('editorPaletteContainer').innerHTML = getPaletteHTML('editorText', 'text', f.color, 'indeditorText') + getPaletteHTML('editorBg', 'bg', f.bgColor, 'indeditorBg');
            
            const isMachine = f.type === 'machine';
            const isText = f.type === 'text';
            const isGrid = f.type === 'grid';
            
            // Hide 'text' option for Choices
            const modeSel = document.getElementById('pMode');
            Array.from(modeSel.options).forEach(opt => {
                if(opt.value === 'text') opt.style.display = (f.type === 'choices') ? 'none' : 'block';
            });
            
            document.getElementById('machineStyleSec').style.display = isMachine ? 'block' : 'none';
            if(isMachine) {
                setV('pMachineStyle', f.machineStyle);
                document.getElementById('machineLogicSec').style.display = 'block';
                renderMachineRules();
            } else {
                document.getElementById('machineLogicSec').style.display = 'none';
            }

            document.getElementById('modeSec').style.display = (['choices'].includes(f.type)) ? 'block' : 'none';
            
            const showMark = ['choices', 'grid'].includes(f.type) || (isMachine && ['radio','checkbox','mixed-radio','mixed-checkbox'].includes(f.machineStyle));
            document.getElementById('markStyleSec').style.display = showMark ? 'block' : 'none';
            if(showMark) setV('pMarkStyle', f.markStyle);

            const showOpts = ['choices', 'dropdown', 'machine', 'shift'].includes(f.type);
            document.getElementById('optSec').style.display = showOpts ? 'block' : 'none';
            if(showOpts) {
                renderSidebarOpts();
                // Hide orientation if dropdown
                const effectiveStyle = isMachine ? f.machineStyle : f.mode;
                document.getElementById('optLayoutContainer').style.display = (f.type === 'dropdown' || effectiveStyle === 'dropdown') ? 'none' : 'block';
            }

            document.getElementById('defValRow').style.display = (isText || (f.mode && f.mode.includes('mixed'))) ? 'block' : 'none';
            
            document.getElementById('customRowSec').style.display = f.type === 'custom_row' ? 'block' : 'none';
            if(f.type === 'custom_row') renderCustomElems();

            document.getElementById('valRulesList').innerHTML = '';
            renderValRules();

            document.getElementById('gridSec').style.display = isGrid ? 'block' : 'none';
            if(isGrid) {
                setC('pCorner', f.corner);
                setC('pShowCol', f.showCol);
                setC('pShowRow', f.showRow);
            }

            document.getElementById('unitSec').style.display = isText ? 'block' : 'none';
            if(isText && f.uEnable) renderRules();

            render();
        }

        function apply() {
            if(!activeId) return;
            const f = fields.find(x => x.id === activeId);
            
            f.size = document.getElementById('pSize').value;
            f.width = document.getElementById('pWidth').value;
            f.req = document.getElementById('pReq').checked;
            f.descE = document.getElementById('pDescE').checked;
            
            f.mode = document.getElementById('pMode').value;
            if(document.getElementById('pMachineStyle')) f.machineStyle = document.getElementById('pMachineStyle').value;
            if(document.getElementById('pMarkStyle')) f.markStyle = document.getElementById('pMarkStyle').value;
            f.optLayout = document.getElementById('pOptLayout').value;

            f.excelKey = document.getElementById('pExcelKey').value;
            f.defVal = document.getElementById('pDefVal').value;
            f.upper = document.getElementById('pUpperCase').checked;
            
            f.uEnable = document.getElementById('pUnitE').checked;
            f.manual = document.getElementById('pManual').checked;
            f.unitB = document.getElementById('pUnitB').value;

            if(f.type === 'grid') {
                f.corner = document.getElementById('pCorner').checked;
                f.showCol = document.getElementById('pShowCol').checked;
                f.showRow = document.getElementById('pShowRow').checked;
            }
            
            select(activeId); 
            render();
        }

        function applyGlobal() {
            formConfig.enableTemp = document.getElementById('gEnableTemp').checked;
            formConfig.layout = document.getElementById('gLayout').value;
            formConfig.metaDescE = document.getElementById('gMetaDescE').checked;
            formConfig.metaStyle.size = document.getElementById('mSize').value;
            render();
        }

        function togglePreviewMode() {
            isPreviewMode = !isPreviewMode;
            document.body.classList.toggle('preview-mode');
            activeId = null; // Deselect
            render();
            
            const btn = document.querySelector('.preview-toggle-btn');
            btn.textContent = isPreviewMode ? 'âœï¸ è¿”å›ç·¨è¼¯æ¨¡å¼' : 'ğŸ‘ï¸ åˆ‡æ›é è¦½æ¸¬è©¦æ¨¡å¼';
            btn.style.background = isPreviewMode ? '#1a73e8' : '#222';
        }

        /* --- Modal Functions --- */
        function openTempModal() { document.getElementById('tempConfigModal').style.display = 'flex'; }
        function closeTempModal() { document.getElementById('tempConfigModal').style.display = 'none'; }

        /* --- Helper Editors --- */
        function renderCustomElems() {
            const f = fields.find(x=>x.id===activeId);
            document.getElementById('customElemList').innerHTML = (f.customElems||[]).map((el,i) => `
                <div class="opt-manage-item">
                    <span style="font-size:11px; font-weight:bold; color:#555;">${el.type}</span>
                    <input style="width:60px;" placeholder="Label/Ph" value="${el.label||el.placeholder||''}" oninput="f.customElems[${i}].${el.type==='input'?'placeholder':'label'}=this.value; render()">
                    ${el.type==='input' ? `<input type="number" style="width:40px;" placeholder="Width" value="${el.width||80}" oninput="f.customElems[${i}].width=this.value; render()">` : ''}
                    <span onclick="f.customElems.splice(${i},1); renderCustomElems(); render()">Ã—</span>
                </div>
            `).join('');
        }
        function addCustomElem(type) {
            const f = fields.find(x=>x.id===activeId);
            f.customElems.push({type, label:type==='text'?'æ¨™ç±¤':'', placeholder:type==='input'?'è¼¸å…¥':''});
            renderCustomElems(); render();
        }

        function renderSidebarOpts() {
            const f = fields.find(x=>x.id===activeId);
            document.getElementById('optList').innerHTML = (f.opts||[]).map((o,i) => `
                <div class="opt-manage-item">
                    <span class="opt-drag-handle">â˜°</span>
                    <input value="${o}" oninput="f.opts[${i}]=this.value; render()"> 
                    <span onclick="f.opts.splice(${i},1); renderSidebarOpts(); render();">Ã—</span>
                </div>`).join('');
            
            new Sortable(document.getElementById('optList'), {
                 handle: '.opt-drag-handle',
                 onEnd: (evt) => {
                     const item = f.opts.splice(evt.oldIndex, 1)[0];
                     f.opts.splice(evt.newIndex, 0, item);
                     render();
                 }
            });
        }
        function addSidebarOpt() { fields.find(x=>x.id===activeId).opts.push('æ–°é¸é …'); renderSidebarOpts(); render(); }
        function bulkAddSidebarOpt() {
            const txt = prompt("è¼¸å…¥é¸é … (æ¯è¡Œä¸€å€‹)");
            if(txt) {
                fields.find(x=>x.id===activeId).opts.push(...txt.split('\n').filter(x=>x));
                renderSidebarOpts(); render();
            }
        }

        function renderMachineRules() {
            const f = fields.find(x=>x.id===activeId);
            document.getElementById('mRules').innerHTML = (f.machineRules||[]).map((r,i) => `
                <div style="background:#fff; border:1px solid #ccc; padding:5px; margin-bottom:5px;">
                    <div style="font-size:11px;">ç•¶æ©Ÿå° = <input value="${r.val}" oninput="f.machineRules[${i}].val=this.value"></div>
                    <div style="font-size:11px;">é€£å‹•ID = <input value="${r.target}" oninput="f.machineRules[${i}].target=this.value"></div>
                    <div style="font-size:11px;">æ–°é¸é … = <input value="${r.targetOpts}" oninput="f.machineRules[${i}].targetOpts=this.value"></div>
                    <div style="text-align:right; font-size:10px; color:red; cursor:pointer;" onclick="f.machineRules.splice(${i},1); renderMachineRules();">åˆªé™¤</div>
                </div>
            `).join('');
        }
        function addMachineRule() { fields.find(x=>x.id===activeId).machineRules.push({val:'', target:'', targetOpts:''}); renderMachineRules(); }

        function renderValRules() {
            const f = fields.find(x=>x.id===activeId);
            document.getElementById('valRulesList').innerHTML = (f.valRules||[]).map((r,i) => `
                <div class="val-rule-item">
                     <select class="val-type-sel" onchange="f.valRules[${i}].target=this.value; renderValRules()">
                        <option value="val" ${r.target==='val'?'selected':''}>æ•¸å€¼</option>
                        <option value="len" ${r.target==='len'?'selected':''}>å­—æ•¸</option>
                     </select>
                     
                     <select style="width:40px" onchange="f.valRules[${i}].op1=this.value">
                        <option value=">">></option><option value="<"><</option>
                        <option value="=">=</option><option value=">=">â‰¥</option>
                        <option value="<=">â‰¤</option>
                     </select>
                     <input style="width:30px" value="${r.val1}" oninput="f.valRules[${i}].val1=this.value">
                     
                     <span style="font-size:10px;">AND</span>
                     
                     <select style="width:40px" onchange="f.valRules[${i}].op2=this.value">
                        <option value=""></option><option value="<"><</option>
                        <option value=">">></option><option value="<=">â‰¤</option>
                     </select>
                     <input style="width:30px" value="${r.val2}" oninput="f.valRules[${i}].val2=this.value">
                     
                     <span class="val-del" onclick="f.valRules.splice(${i},1); renderValRules()">Ã—</span>
                </div>
            `).join('');
        }
        function addValRule() { fields.find(x=>x.id===activeId).valRules.push({target:'val', op1:'>=', val1:'0', op2:'', val2:''}); renderValRules(); }

        function renderRules() {
             const f = fields.find(x=>x.id===activeId);
             document.getElementById('uRules').innerHTML = (f.uRules||[]).map((r,i) => `
                <div class="logic-line">
                    <select onchange="f.uRules[${i}].cond=this.value"><option value=">">></option><option value="<"><</option></select>
                    <input style="width:40px" value="${r.val}" oninput="f.uRules[${i}].val=this.value">
                    <span>å‰‡</span>
                    <input style="width:40px" value="${r.res}" oninput="f.uRules[${i}].res=this.value">
                    <span class="logic-del-btn" onclick="f.uRules.splice(${i},1); renderRules()">ğŸ—‘</span>
                </div>
             `).join('');
        }
        function addURule() { fields.find(x=>x.id===activeId).uRules.push({cond:'>', val:'', res:''}); renderRules(); }

        /* --- Field Utils --- */
        function updateField(id, key, val) { fields.find(x=>x.id===id)[key] = val; }
        function autoResize(el) { el.style.height='auto'; el.style.height = el.scrollHeight+'px'; }
        function copyF(id) { const f = JSON.parse(JSON.stringify(fields.find(x=>x.id===id))); f.id='f'+Date.now(); fields.push(f); render(); }
        function delF(id) { fields = fields.filter(x=>x.id!==id); activeId=null; render(); }
        
        function addCol(id) { 
            const f=fields.find(x=>x.id===id); f.cols.push(`Col ${f.cols.length+1}`);
            f.cellModes.forEach(row => row.push('text')); render(); select(id); 
        }
        function delCol(id, i) { 
            const f=fields.find(x=>x.id===id); if(f.cols.length>1){ f.cols.splice(i,1); f.cellModes.forEach(row => row.splice(i,1)); render(); select(id); } 
        }
        function addRow(id) { 
            const f=fields.find(x=>x.id===id); f.rows.push(`Row ${f.rows.length+1}`); f.cellModes.push(new Array(f.cols.length).fill('text')); render(); select(id); 
        }
        function delRow(id, i) { 
            const f=fields.find(x=>x.id===id); if(f.rows.length>1){ f.rows.splice(i,1); f.cellModes.splice(i,1); render(); select(id); } 
        }

        function hExport() {
            const blob = new Blob([JSON.stringify({config:formConfig, fields}, null, 2)], {type:'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='form_schema.json'; a.click();
        }
        function hImport(inp) {
            const r = new FileReader();
            r.onload = e => {
                const d = JSON.parse(e.target.result);
                if(d.fields) fields = d.fields;
                if(d.config) formConfig = d.config;
                render();
            };
            r.readAsText(inp.files[0]);
        }
    </script>
</body>
</html>
